(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{310:function(s,n,e){"use strict";e.r(n);var a=e(14),r=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("上一篇说到要做到服务的灵活伸缩需要有一种机制来实现，这个机制就是服务注册与发现。这并不是必须的，如果服务实例很少并且很稳定，就没有必要使用。")]),s._v(" "),n("h1",{attrs:{id:"概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),n("ul",[n("li",[s._v("服务注册：简单理解就是有一个注册中心，每个服务实例启动时都去注册中心注册，告诉注册中心地址，端口等信息。同样删除时，也需要去注册中心删除，注册中心负责维护这些服务实例的信息")]),s._v(" "),n("li",[s._v("服务发现：既然注册中心维护了各个服务实例的信息，那么客户端通过注册中心就很容易能发现服务的变化。有了服务注册与发现，客户端就不用再去配置各个服务实例的地址，改为从注册中心统一获取")]),s._v(" "),n("li",[s._v("健康检查：注册中心要保证每个地址的可用状态，挂掉的实例不应该被客户端获取到，所以需要：健康检查。每个服务都需要提供一个用于健康检查的接口，这个接口不具备任何业务功能。服务注册时把这个接口的地址也告诉注册中心，注册中心会定时调用这个接口来检测服务是否正常，如果不正常，则将它移除，这样来保证了服务的可用性")])]),s._v(" "),n("p",[s._v("常见注册中心有 "),n("code",[s._v("Consul")]),s._v("、"),n("code",[s._v("ZooKeeper")]),s._v("、"),n("code",[s._v("etcd")]),s._v("、"),n("code",[s._v("Eureka")]),s._v("。")]),s._v(" "),n("h1",{attrs:{id:"consul"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#consul"}},[s._v("#")]),s._v(" Consul")]),s._v(" "),n("p",[s._v("Consul官网："),n("a",{attrs:{href:"https://www.consul.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.consul.io"),n("OutboundLink")],1),s._v("，主要功能有服务注册与发现、健康检查、K-V存储、多数据中心等，这里不做详细介绍。")]),s._v(" "),n("ul",[n("li",[s._v("安装：直接在官网下载解压即可")]),s._v(" "),n("li",[s._v("运行：在 "),n("code",[s._v("consul.exe")]),s._v(" 目录下打开命令行执行 "),n("code",[s._v("consul.exe agent -dev")])]),s._v(" "),n("li",[s._v("浏览器访问："),n("a",{attrs:{href:"http://localhost:8500/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://localhost:8500"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("这里选择使用Docker来部署Consul：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker pull consul \ndocker run -d -p 8500:8500 --restart=always --name=consul consul:latest agent -server -bootstrap -ui -node=1 -client='0.0.0.0'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("agent")]),s._v("： 表示启动 Agent 进程")]),s._v(" "),n("li",[n("code",[s._v("server")]),s._v("：表示启动 Consul Server 模式")]),s._v(" "),n("li",[n("code",[s._v("client")]),s._v("：表示启动 Consul Cilent 模式")]),s._v(" "),n("li",[n("code",[s._v("bootstrap")]),s._v("：表示这个节点是 Server-Leader ，每个数据中心只能运行一台服务器。技术角度上来看 Leader 是通过 Raft 算法选举的，但是集群第一次启动时需要一个引导 Leader，在引导群集后，建议不要使用此标志")]),s._v(" "),n("li",[n("code",[s._v("ui")]),s._v("：表示启动 Web UI 管理器，默认开放端口 "),n("code",[s._v("8500")]),s._v("，所以上面使用 Docker 命令把 "),n("code",[s._v("8500")]),s._v(" 端口对外开放")]),s._v(" "),n("li",[n("code",[s._v("node")]),s._v("：节点的名称，集群中必须是唯一的，默认是该节点的主机名")]),s._v(" "),n("li",[n("code",[s._v("client")]),s._v("：Consul服务监听地址，这提供"),n("code",[s._v("HTTP")]),s._v("、"),n("code",[s._v("DNS")]),s._v("、"),n("code",[s._v("RPC")]),s._v("等服务，默认是 "),n("code",[s._v("127.0.0.1")]),s._v(" 所以不对外提供服务，如果要对外提供服务改成 "),n("code",[s._v("0.0.0.0")])]),s._v(" "),n("li",[n("code",[s._v("join")]),s._v("：表示加入到某一个集群中。 如："),n("code",[s._v("-json=192.168.0.11")])])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-17-20-00-01.png",alt:"img"}})]),s._v(" "),n("p",[s._v("这里看到Consul已经成功运行。")]),s._v(" "),n("h1",{attrs:{id:"服务注册"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#服务注册"}},[s._v("#")]),s._v(" 服务注册")]),s._v(" "),n("p",[s._v("订单服务项目使用"),n("code",[s._v("Nuget")]),s._v(" 安装 "),n("code",[s._v("Consul")]),s._v("，然后添加相关代码：")]),s._v(" "),n("p",[s._v("ConsulHelper.cs：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('public static class ConsulHelper\n{\n    /// <summary>\n    /// 服务注册\n    /// </summary>\n    /// <param name="app">The application.</param>\n    /// <param name="configuration">The configuration.</param>\n    /// <param name="lifetime">The lifetime.</param>\n    /// <returns></returns>\n    public static IApplicationBuilder RegisterConsul(this IApplicationBuilder app\n        , IConfiguration configuration\n        , IHostApplicationLifetime lifetime)\n    {\n        var consulClient = new ConsulClient(c =>\n        {\n            c.Address = new Uri(configuration["ConsulSetting:ConsulAddress"]);\n        });\n\n        var registration = new AgentServiceRegistration()\n        {\n            // 服务实例唯一标识\n            ID = Guid.NewGuid().ToString(),\n            // 服务名称\n            Name = configuration["ConsulSetting:ServiceName"],\n            // 服务IP地址\n            Address = configuration["ConsulSetting:ServiceIP"],\n            // 服务端口：因为要运行多个实例，端口不能在appsettings.json里配置而是在docker容器运行时传入\n            Port = int.Parse(configuration["ConsulSetting:ServicePort"]),\n            Check = new AgentServiceCheck()\n            {\n                // 服务启动多久后注册\n                DeregisterCriticalServiceAfter = TimeSpan.FromSeconds(3),\n                // 健康检查时间间隔\n                Interval = TimeSpan.FromSeconds(10),\n                // 健康检查地址\n                HTTP = $"http://{configuration["ConsulSetting:ServiceIP"]}:{configuration["ConsulSetting:ServicePort"]}{configuration["ConsulSetting:ServiceHealthCheck"]}",\n                // 超时时间\n                Timeout = TimeSpan.FromSeconds(5)\n            }\n        };\n\n        // 服务注册\n        consulClient.Agent.ServiceRegister(registration).Wait();\n\n        // 应用程序终止时，取消注册\n        lifetime.ApplicationStopping.Register(() =>\n        {\n            consulClient.Agent.ServiceDeregister(registration.ID).Wait();\n        });\n        return app;\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br")])]),n("p",[s._v("appsettings.json：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n  "Logging": {\n    "LogLevel": {\n      "Default": "Information",\n      "Microsoft": "Warning",\n      "Microsoft.Hosting.Lifetime": "Information"\n    }\n  },\n  "AllowedHosts": "*",\n  "ConsulSetting": {\n    "ServiceName": "order.service",\n    "ServiceIP": "192.168.31.191",\n    "ServiceHealthCheck": "/healthcheck",\n    "ConsulAddress": "http://192.168.31.191:8500"\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("blockquote",[n("p",[s._v("注意：这里没有配置ServicePort，所以如果本地直接运行项目会报错")])]),s._v(" "),n("p",[s._v("Startup.cs：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public void Configure(IApplicationBuilder app, IWebHostEnvironment env, IHostApplicationLifetime lifetime)\n{\n    if (env.IsDevelopment())\n    { }\n    else\n    { }\n\n    app.UseStaticFiles();\n\n    app.UseRouting();\n    app.UseEndpoints(endpoints =>\n    {\n        endpoints.MapControllers();\n    });\n\n    // 启用服务注册\n    app.RegisterConsul(Configuration, lifetime);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("OrdersController.cs：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[Route("[Controller]")]\n[ApiController]\npublic class OrdersController : ControllerBase\n{\n    private readonly IConfiguration configuration;\n\n    public OrdersController(IConfiguration configuration)\n    {\n        this.configuration = configuration;\n    }\n\n    [HttpGet]\n    public IActionResult Index()\n    {\n        string result = $"订单服务：{DateTime.Now:yyyy-MM-dd HH:mm:ss},-{Request.HttpContext.Connection.LocalIpAddress}:{configuration["ConsulSetting:ServicePort"]}";\n        return Ok(result);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("HealthCheckController.cs：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[Route("[controller]")]\n[ApiController]\npublic class HealthCheckController : ControllerBase\n{\n    /// <summary>\n    /// 健康检查接口\n    /// </summary>\n    /// <returns></returns>\n    [HttpGet]\n    public IActionResult Get()\n    {\n        return Ok("Pong.");\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("至此就完成了服务注册、取消注册、健康检查的代码编写，下面重新 "),n("code",[s._v("build")]),s._v(" 镜像（过程略过）运行新的容器：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@centos-01 order.api.release]# docker run -d --name order.api -p 80:80 order.api  --ConsulSetting:ServicePort="80"\n89acc7d7035f2041a91bc1e1299464a5460290dd66b12161ee4e994d5548def2\n[root@centos-01 order.api.release]# docker run -d --name order.api1 -p 81:80 order.api --ConsulSetting:ServicePort="81"\n223be73a41e501e168fdc44459cd6f5851d565e60817dbd0047dff7718394e22\n[root@centos-01 order.api.release]# docker run -d --name order.api2 -p 82:80 order.api --ConsulSetting:ServicePort="82"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-17-20-36-21.png",alt:"img"}}),s._v(" "),n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-17-20-36-40.png",alt:"img"}})]),s._v(" "),n("p",[s._v("至此，3个服务实例都已运行，并且成功注册到 Consul。测试一下服务停止会不会从Consul移除：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[root@centos-01 order.api.release]# docker stop order.api\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-17-20-39-00.png",alt:"img"}})]),s._v(" "),n("p",[s._v("这里需要注意：程序发生异常，健康检查不能正确响应的话，Consul也会移除。至此注册、发现、健康检查功能都完成了，下一步考虑客户端如何拿到这些服务实例的地址。")]),s._v(" "),n("h1",{attrs:{id:"客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),n("p",[s._v("上面已经成功将服务注册到 Consul中，接下来就该客户端通过 Consul 去做服务发现了。客户端项目同样使用"),n("code",[s._v("Nuget")]),s._v(" 安装 Consul，然后调整相关代码：")]),s._v(" "),n("p",[s._v("ServiceHelper.cs：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('using Consul;\n\nusing Microsoft.Extensions.Configuration;\n\nusing RestSharp;\n\nusing System;\nusing System.Collections.Concurrent;\nusing System.Linq;\nusing System.Threading.Tasks;\n\nnamespace Web.Client\n{\n    public interface IServiceHelper\n    {\n        Task<string> GetOrder();\n    }\n\n    public class ServiceHelper : IServiceHelper\n    {\n        private readonly IConfiguration configuration;\n\n        public ServiceHelper(IConfiguration configuration)\n        {\n            this.configuration = configuration;\n        }\n\n        public async Task<string> GetOrder()\n        {\n            var consulClient = new ConsulClient(c =>\n            {\n                c.Address = new Uri(configuration["ConsulSetting:ConsulAddress"]);\n            });\n\n            // 获取健康的服务\n            var services = consulClient.Health.Service("order.service", null, true, null).Result.Response;\n            // 获取订单服务地址列表\n            string[] serviceUrls = services.Select(p => $"http://{p.Service.Address + ":" + p.Service.Port}").ToArray();\n\n            if (!serviceUrls.Any())\n            {\n                return await Task.FromResult("【订单服务】服务列表为空");\n            }\n\n            // 每次随机访问一个服务实例\n            var client = new RestClient(serviceUrls[new Random().Next(0, serviceUrls.Length)]);\n            var request = new RestRequest("/orders", Method.GET);\n\n            var response = await client.ExecuteAsync(request);\n            return response.Content;\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br")])]),n("p",[s._v("appsettings.json：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n  "Logging": {\n    "LogLevel": {\n      "Default": "Information",\n      "Microsoft": "Warning",\n      "Microsoft.Hosting.Lifetime": "Information"\n    }\n  },\n  "AllowedHosts": "*",\n  "ConsulSetting": {\n    "ConsulAddress": "http://192.168.31.191:8500"\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("以上代码就完成了对服务列表的获取，浏览器访问测试一下：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-17-20-48-22.png",alt:"img"}})]),s._v(" "),n("p",[s._v("这时候如果停止其中一个服务实例，Consul中也会同步下线，客户端也就访问不到了，但是只要三个实例活着一个就可以正常访问。虽然这里解决了服务发现的问题，但是新的问题又来了：客户端每次调用服务都需要先去Consul中获取服务地址，不仅浪费资源还增加了请求的响应时间。如何保证不要每次请求都需要去Consul 获取地址的同时又可以拿到可用的地址列表呢？Consul 提供的解决方案是：Blocking Queries （阻塞的请求）。详情见官网："),n("a",{attrs:{href:"https://www.consul.io/api-docs/features/blocking",target:"_blank",rel:"noopener noreferrer"}},[s._v("Blocking Queries"),n("OutboundLink")],1),s._v(" 。")]),s._v(" "),n("h1",{attrs:{id:"blocking-queries"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#blocking-queries"}},[s._v("#")]),s._v(" Blocking Queries")]),s._v(" "),n("p",[s._v("简单来说就是当客户端请求 Consul 获取地址列表时，需要携带一个版本号信息，Consul 会比较这个客户端版本号是否和 Consul 服务端的版本号一致，如果一致，则 Consul 会阻塞这个请求，直到 Consul 中的服务列表发生变化，或者到达阻塞时间上限；如果版本号不一致，则立即返回。这个阻塞时间默认是5分钟，支持自定义。如果启动一个线程专门去做这件事，就不会影响每次的用户请求了。这样既保证了客户端服务列表的准确性，又节约了客户端请求服务列表的次数。")]),s._v(" "),n("p",[s._v("调整代码：")]),s._v(" "),n("p",[s._v("IServiceHelper.cs 增加获取服务列表的接口方法：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('using Consul;\n\nusing Microsoft.Extensions.Configuration;\n\nusing RestSharp;\n\nusing System;\nusing System.Collections.Concurrent;\nusing System.Linq;\nusing System.Threading.Tasks;\n\nnamespace Web.Client\n{\n    public interface IServiceHelper\n    {\n        Task<string> GetOrder();\n\n        void GetServices();\n    }\n\n    public class ServiceHelper : IServiceHelper\n    {\n        private readonly IConfiguration configuration;\n        private readonly ConsulClient consulClient;\n        private ConcurrentBag<string> orderServiceUrls;\n\n        public ServiceHelper(IConfiguration configuration)\n        {\n            this.configuration = configuration;\n            this.consulClient = new ConsulClient(c =>\n            {\n                c.Address = new Uri(configuration["ConsulSetting:ConsulAddress"]);\n            });\n        }\n\n        public async Task<string> GetOrder()\n        {\n            if (orderServiceUrls == null)\n                return await Task.FromResult("【订单服务】初始化服务列表...");\n\n            var client = new RestClient(orderServiceUrls.ElementAt(new Random().Next(0, orderServiceUrls.Count())));\n            var request = new RestRequest("/orders", Method.GET);\n\n            var response = await client.ExecuteAsync(request);\n            return response.Content;\n        }\n\n        public void GetServices()\n        {\n            var serviceNames = new string[] { "order.service" };\n            Array.ForEach(serviceNames, p =>\n            {\n                Task.Run(() =>\n                {\n                    // WaitTime默认为5分钟\n                    var queryOptions = new QueryOptions { WaitTime = TimeSpan.FromMinutes(10) };\n                    while (true)\n                    {\n                        GetServices(queryOptions, p);\n                    }\n                });\n            });\n        }\n        private void GetServices(QueryOptions queryOptions, string serviceName)\n        {\n            var res = consulClient.Health.Service(serviceName, null, true, queryOptions).Result;\n\n            // 打印服务列表的响应时间等信息\n            Console.WriteLine($"{DateTime.Now}获取{serviceName}：queryOptions.WaitIndex：{queryOptions.WaitIndex}  LastIndex：{res.LastIndex}");\n\n            // 版本号不一致 说明服务列表发生变化\n            if (queryOptions.WaitIndex != res.LastIndex)\n            {\n                queryOptions.WaitIndex = res.LastIndex;\n\n                //服务地址列表\n                var serviceUrls = res.Response.Select(p => $"http://{p.Service.Address + ":" + p.Service.Port}").ToArray();\n\n                if (serviceName == "order.service")\n                    orderServiceUrls = new ConcurrentBag<string>(serviceUrls);\n            }\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-17-21-02-33.png",alt:"img"}})]),s._v(" "),n("p",[s._v("至此不需要每次都先请求服务列表，如果服务列表没有更新的话，获取列表的请求会一直阻塞直到设置的10分钟。这时候又发现新的问题：")]),s._v(" "),n("ol",[n("li",[s._v("每个客户端系统都去维护服务地址是否合理")]),s._v(" "),n("li",[s._v("服务的IP端口直接暴露给所有客户端是否安全")]),s._v(" "),n("li",[s._v("该模式下怎么做到客户端的统一管理")])])])}),[],!1,null,null,null);n.default=r.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{304:function(s,n,a){"use strict";a.r(n);var e=a(14),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("上一篇中已经完成了 Ocelot + Consul 的搭建，这篇简单说一下事件总线（"),n("code",[s._v("EventBus")]),s._v(")。")]),s._v(" "),n("h1",{attrs:{id:"事件总线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件总线"}},[s._v("#")]),s._v(" 事件总线")]),s._v(" "),n("p",[s._v("什么是事件总线？")]),s._v(" "),n("blockquote",[n("p",[s._v("事件总线是对观察者（发布-订阅）模式的一种实现。它是一种集中式事件处理机制，允许不同的组件之间进行彼此通信而又不需要相互依赖，达到解耦的目的")])]),s._v(" "),n("p",[s._v("为什么要使用事件总线？")]),s._v(" "),n("blockquote",[n("ol",[n("li",[s._v("以当前项目举例，假设有一个订单服务，一个产品服务。客户端有一个下单功能，下单时调用订单服务的下单接口，下单接口需要调用产品服务的减库存接口，这涉及到服务与服务之间的调用。服务之间调用可以选择 "),n("code",[s._v("RestAPI")]),s._v(" 或者效率更高的 "),n("code",[s._v("gRPC")]),s._v("。可能这两者各有各的使用场景，但是它们都存在服务之间的耦合问题，或者难以做到异步调用")]),s._v(" "),n("li",[s._v("假设下单调用订单服务，订单服务需要调用产品服务，产品服务又要调用物流服务，物流服务再去调用xx服务等等，如果每个服务处理时间需要2s，不使用异步处理的话，响应时间可想而知。如果使用EventBus的话，那么订单服务只需要向EventBus发一个“下单事件”就可以了。产品服务会订阅“下单事件”，当产品服务收到下单事件时，自己去减库存。这样就避免了两个服务之间直接调用的耦合性，并且真正做到了异步调用")])])]),s._v(" "),n("p",[s._v("既然涉及到多个服务之间的异步调用，那么就不得不提分布式事务。分布式事务并不是微服务独有的问题，而是所有的分布式系统都会存在的问题。关于分布式事务，可以查一下 “CAP原则” 和 “BASE理论” 了解更多。如今分布式系统更多时候会追求事务的最终一致性。")]),s._v(" "),n("p",[s._v("下面使用开源框架 "),n("code",[s._v("CAP")]),s._v("来演示 "),n("code",[s._v("EventBus")]),s._v(" 的基本使用。之所以使用 "),n("code",[s._v("CAP")]),s._v(" 是因为它既能解决分布式系统的最终一致性，同时又是一个 "),n("code",[s._v("EventBus")]),s._v("，它具备"),n("code",[s._v("EventBus")]),s._v(" 的所有功能。"),n("a",{attrs:{href:"https://www.cnblogs.com/savorboard/p/cap.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("点击了解更多"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h1",{attrs:{id:"cap"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cap"}},[s._v("#")]),s._v(" CAP")]),s._v(" "),n("p",[s._v("目前 CAP 支持使用 "),n("code",[s._v("RabbitMQ")]),s._v(" ，"),n("code",[s._v("Kafka")]),s._v("，"),n("code",[s._v("Azure Service Bus")]),s._v(" 等进行底层之间的消息发送，不需要具备这些消息队列的使用经验就可以轻松的集成到项目中。CAP 目前支持使用 "),n("code",[s._v("Sql Server")]),s._v("，"),n("code",[s._v("MySql")]),s._v("，"),n("code",[s._v("PostgreSql")]),s._v("，"),n("code",[s._v("MongoDB")]),s._v(" 数据库的项目。这里选择：消息组件使用 "),n("code",[s._v("RabbitMq")]),s._v("，数据库存储使用 "),n("code",[s._v("SqlServer")]),s._v("。")]),s._v(" "),n("p",[n("code",[s._v("Nuget")]),s._v(" 安装 :")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Microsoft.EntityFrameworkCore\nMicrosoft.EntityFrameworkCore.Tools\nMicrosoft.EntityFrameworkCore.SqlServer\nDotNetCore.CAP\nDotNetCore.CAP.RabbitMQ\nDotNetCore.CAP.SqlServer\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h1",{attrs:{id:"product-api"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#product-api"}},[s._v("#")]),s._v(" Product.Api")]),s._v(" "),n("p",[s._v("新增 "),n("code",[s._v("Product.Api")]),s._v(" 作为产品服务，代码结构与 "),n("code",[s._v("Order.Api")]),s._v(" 结构类似：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-01-07-00.png",alt:"img"}})]),s._v(" "),n("h2",{attrs:{id:"productscontroller-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#productscontroller-cs"}},[s._v("#")]),s._v(" ProductsController.cs")]),s._v(" "),n("p",[s._v("增加减库存接口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('using DotNetCore.CAP;\n\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Configuration;\n\nusing Newtonsoft.Json;\n\nusing Product.Api.Models;\n\nusing System;\nusing System.Threading.Tasks;\n\nnamespace Product.Api.Controller\n{\n    [Route("[Controller]")]\n    [ApiController]\n    public class ProductsController : ControllerBase\n    {\n        private readonly IConfiguration configuration;\n        private readonly ICapPublisher capBus;\n        private readonly ProductContext context;\n\n        public ProductsController(IConfiguration configuration, ICapPublisher capBus, ProductContext context)\n        {\n            this.configuration = configuration;\n            this.capBus = capBus;\n            this.context = context;\n        }\n\n        [HttpGet]\n        public IActionResult Index()\n        {\n            string result = $"产品服务：{DateTime.Now:yyyy-MM-dd HH:mm:ss},-{Request.HttpContext.Connection.LocalIpAddress}:{configuration["ConsulSetting:ServicePort"]}";\n            return Ok(result);\n        }\n\n        /// <summary>\n        /// 减库存 订阅下单事件\n        /// </summary>\n        /// <param name="message"></param>\n        /// <returns></returns>\n        [NonAction]\n        [CapSubscribe("order.services.createorder")]\n        public async Task ReduceStock(CreateOrderMessageDto message)\n        {\n            Console.WriteLine("message:" + JsonConvert.SerializeObject(message));\n            var product = await context.Products.FirstOrDefaultAsync(p => p.ID == message.ProductID);\n            product.Stock -= message.Count;\n            await context.SaveChangesAsync();\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br")])]),n("h2",{attrs:{id:"createordermessagedto-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#createordermessagedto-cs"}},[s._v("#")]),s._v(" CreateOrderMessageDto.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("namespace Product.Api.Models\n{\n    /// <summary>\n    /// 下单事件消息\n    /// </summary>\n    public class CreateOrderMessageDto\n    {\n        /// <summary>\n        /// 产品ID\n        /// </summary>\n        public int ProductID { get; set; }\n\n        /// <summary>\n        /// 购买数量\n        /// </summary>\n        public int Count { get; set; }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h2",{attrs:{id:"product-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#product-cs"}},[s._v("#")]),s._v(" Product.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('using System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace Product.Api.Models\n{\n    public class Product\n    {\n        [Key]\n        public int ID { get; set; }\n\n        /// <summary>\n        /// 产品名称\n        /// </summary>\n        [Required]\n        [Column(TypeName = "VARCHAR(16)")]\n        public string Name { get; set; }\n\n        /// <summary>\n        /// 库存\n        /// </summary>\n        [Required]\n        public int Stock { get; set; }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("h2",{attrs:{id:"productcontext-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#productcontext-cs"}},[s._v("#")]),s._v(" ProductContext.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('using Microsoft.EntityFrameworkCore;\n\nnamespace Product.Api\n{\n    public class ProductContext : DbContext\n    {\n        public ProductContext(DbContextOptions<ProductContext> options)\n           : base(options)\n        {\n\n        }\n\n        public DbSet<Models.Product> Products { get; set; }\n\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n            //初始化种子数据\n            modelBuilder.Entity<Models.Product>().HasData(new Models.Product\n            {\n                ID = 1,\n                Name = "ThinkPad",\n                Stock = 100\n            },\n            new Models.Product\n            {\n                ID = 2,\n                Name = "Mac",\n                Stock = 100\n            });\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("h2",{attrs:{id:"appsettings-json"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#appsettings-json"}},[s._v("#")]),s._v(" appsettings.json")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n  "Logging": {\n    "LogLevel": {\n      "Default": "Information",\n      "Microsoft": "Warning",\n      "Microsoft.Hosting.Lifetime": "Information"\n    }\n  },\n  "AllowedHosts": "*",\n  "ConsulSetting": {\n    "ServiceName": "product.service",\n    "ServiceIP": "192.168.31.191",\n    "ServiceHealthCheck": "/healthcheck",\n    "ConsulAddress": "http://192.168.31.191:8500"\n  },\n  "ConnectionString": "Server=192.168.31.210;Database=Microservice.Sample.Product;user id=sa;password=wpl19950815;MultipleActiveResultSets=true"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h2",{attrs:{id:"startup-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#startup-cs"}},[s._v("#")]),s._v(" Startup.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('public void ConfigureServices(IServiceCollection services)\n{\n    services.AddControllers();\n\n    services.AddDbContext<ProductContext>(opt => opt.UseSqlServer(Configuration["ConnectionString"]));\n\n    services.AddCap(x =>\n    {\n        x.UseEntityFramework<ProductContext>().UseRabbitMQ(option =>\n        {\n            option.HostName = "192.168.31.191";\n            option.UserName = "guest";\n            option.Password = "guest";\n        });\n    });\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h1",{attrs:{id:"order-api"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#order-api"}},[s._v("#")]),s._v(" Order.Api")]),s._v(" "),n("h2",{attrs:{id:"orderscontroller-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#orderscontroller-cs"}},[s._v("#")]),s._v(" OrdersController.cs")]),s._v(" "),n("p",[s._v("增加下单接口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('using DotNetCore.CAP;\n\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.Extensions.Configuration;\n\nusing Order.Api.Models;\n\nusing System;\nusing System.Threading.Tasks;\n\nnamespace Order.Api.Controller\n{\n    [Route("[Controller]")]\n    [ApiController]\n    public class OrdersController : ControllerBase\n    {\n        private readonly IConfiguration configuration;\n        private readonly ICapPublisher capBus;\n        private readonly OrderContext context;\n\n        public OrdersController(IConfiguration configuration, ICapPublisher capBus, OrderContext context)\n        {\n            this.configuration = configuration;\n            this.capBus = capBus;\n            this.context = context;\n        }\n\n        [HttpGet]\n        public IActionResult Index()\n        {\n            string result = $"订单服务：{DateTime.Now:yyyy-MM-dd HH:mm:ss},-{Request.HttpContext.Connection.LocalIpAddress}:{configuration["ConsulSetting:ServicePort"]}";\n            return Ok(result);\n        }\n\n        /// <summary>\n        /// 创建订单\n        /// </summary>\n        /// <param name="order"></param>\n        /// <returns></returns>\n        [Route("Create")]\n        [HttpPost]\n        public async Task<IActionResult> CreateOrder(Models.Order order)\n        {\n            using (var trans = context.Database.BeginTransaction(capBus, autoCommit: true))\n            {\n                order.CreateTime = DateTime.Now;\n                context.Orders.Add(order);\n\n                var result = await context.SaveChangesAsync() > 0;\n\n                if (result)\n                {\n                    // 发布下单事件\n                    await capBus.PublishAsync("order.services.createorder",\n                        new CreateOrderMessageDto() { Count = order.Count, ProductID = order.ProductID });\n                    return Ok();\n                }\n                return BadRequest();\n            }\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br")])]),n("h2",{attrs:{id:"createordermessagedto-cs-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#createordermessagedto-cs-2"}},[s._v("#")]),s._v(" CreateOrderMessageDto.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("namespace Order.Api.Models\n{\n    /// <summary>\n    /// 下单事件消息\n    /// </summary>\n    public class CreateOrderMessageDto\n    {\n        /// <summary>\n        /// 产品ID\n        /// </summary>\n        public int ProductID { get; set; }\n\n        /// <summary>\n        /// 购买数量\n        /// </summary>\n        public int Count { get; set; }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h2",{attrs:{id:"order-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#order-cs"}},[s._v("#")]),s._v(" Order.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace Order.Api.Models\n{\n    public class Order\n    {\n        [Key]\n        public int ID { get; set; }\n\n        /// <summary>\n        /// 下单时间\n        /// </summary>\n        [Required]\n        public DateTime CreateTime { get; set; }\n\n        /// <summary>\n        /// 产品ID\n        /// </summary>\n        [Required]\n        public int ProductID { get; set; }\n\n        /// <summary>\n        /// 购买数量\n        /// </summary>\n        [Required]\n        public int Count { get; set; }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("h2",{attrs:{id:"ordercontext-cs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ordercontext-cs"}},[s._v("#")]),s._v(" OrderContext.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("using Microsoft.EntityFrameworkCore;\n\nnamespace Order.Api\n{\n    public class OrderContext : DbContext\n    {\n        public OrderContext(DbContextOptions<OrderContext> options)\n           : base(options)\n        {\n\n        }\n\n        public DbSet<Models.Order> Orders { get; set; }\n\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n\n        }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h2",{attrs:{id:"appsettings-json-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#appsettings-json-2"}},[s._v("#")]),s._v(" appsettings.json")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n  "Logging": {\n    "LogLevel": {\n      "Default": "Information",\n      "Microsoft": "Warning",\n      "Microsoft.Hosting.Lifetime": "Information"\n    }\n  },\n  "AllowedHosts": "*",\n  "ConsulSetting": {\n    "ServiceName": "order.service",\n    "ServiceIP": "192.168.31.191",\n    "ServiceHealthCheck": "/healthcheck",\n    "ConsulAddress": "http://192.168.31.191:8500"\n  },\n  "ConnectionString": "Server=192.168.31.210;Database=Microservice.Sample.Order;user id=sa;password=wpl19950815;MultipleActiveResultSets=true"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h2",{attrs:{id:"startup-cs-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#startup-cs-2"}},[s._v("#")]),s._v(" Startup.cs")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('public void ConfigureServices(IServiceCollection services)\n{\n    services.AddControllers();\n\n    services.AddDbContext<OrderContext>(opt => opt.UseSqlServer(Configuration["ConnectionString"]));\n\n    services.AddCap(x =>\n    {\n        x.UseEntityFramework<OrderContext>().UseRabbitMQ(option =>\n        {\n            option.HostName = "192.168.31.191";\n            option.UserName = "guest";\n            option.Password = "guest";\n        });\n    });\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-01-20-20.png",alt:"img"}})]),s._v(" "),n("p",[s._v("以上就是产品服务的新增以及订单服务的部分代码调整，功能很简单：各自添加自己的数据库表，订单服务增加下单接口，下单接口会发出“下单事件”。产品服务增加减库存接口，减库存接口会订阅“下单事件”。然后客户端调用下单接口下单时，产品服务会减去相应的库存。关于EF数据库迁移之类的基本使用不做介绍。")]),s._v(" "),n("h1",{attrs:{id:"重新构建镜像"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#重新构建镜像"}},[s._v("#")]),s._v(" 重新构建镜像")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@centos-01 dotnetcore_src]# cd order.api.release/\n[root@centos-01 order.api.release]# docker build -t order.api .\nSending build context to Docker daemon  16.05MB\nStep 1/4 : FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base\n ---\x3e a2be3e478ffa\nStep 2/4 : WORKDIR /app\n ---\x3e Using cache\n ---\x3e 9f551bd1698a\nStep 3/4 : COPY . /app\n ---\x3e e19ab440e8a5\nStep 4/4 : ENTRYPOINT ["dotnet", "Order.Api.dll"]\n ---\x3e Running in 3d1e4110f02e\nRemoving intermediate container 3d1e4110f02e\n ---\x3e 06322a6c6e83\nSuccessfully built 06322a6c6e83\nSuccessfully tagged order.api:latest\n\n[root@centos-01 order.api.release]# cd ../product.api.release/\n[root@centos-01 product.api.release]# docker build -t product.api .\nSending build context to Docker daemon  16.38MB\nStep 1/4 : FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base\n ---\x3e a2be3e478ffa\nStep 2/4 : WORKDIR /app\n ---\x3e Using cache\n ---\x3e 9f551bd1698a\nStep 3/4 : COPY . /app\n ---\x3e 6f6d08e02d78\nStep 4/4 : ENTRYPOINT ["dotnet", "Product.Api.dll"]\n ---\x3e Running in 7616a505741e\nRemoving intermediate container 7616a505741e\n ---\x3e 6be08521c6fe\nSuccessfully built 6be08521c6fe\nSuccessfully tagged product.api:latest\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("p",[s._v("运行订单服务，产品服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('docker run -d --name order.api -p 80:80 order.api  --ConsulSetting:ServicePort="80"\ndocker run -d --name order.api1 -p 81:80 order.api --ConsulSetting:ServicePort="81"\ndocker run -d --name order.api2 -p 82:80 order.api --ConsulSetting:ServicePort="82"\ndocker run -d --name product.api -p 85:80 product.api --ConsulSetting:ServicePort="85"\ndocker run -d --name product.api1 -p 86:80 product.api --ConsulSetting:ServicePort="86"\ndocker run -d --name product.api2 -p 87:80 product.api --ConsulSetting:ServicePort="87"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-01-51-19.png",alt:"img"}})]),s._v(" "),n("p",[n("code",[s._v("ocelot.json")]),s._v(" 增加路由配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n  "Routes": [\n    {\n      // 路由规则匹配\n      "DownstreamPathTemplate": "/orders/{url}",\n      "DownstreamScheme": "http",\n      "UpstreamPathTemplate": "/orders/{url}",\n      // 增加Post请求\n      "UpstreamHttpMethod": [ "Get", "Post" ],\n      "ServiceName": "order.service",\n      "LoadBalancerOptions": {\n        "Type": "RoundRobin"\n      },\n      // 缓存\n      "FileCacheOptions": {\n        "TtlSeconds": 5,\n        "Region": "regionname"\n      },\n      // 限流\n      "RateLimitOptions": {\n        "ClientWhitelist": [ "SuperClient" ],\n        "EnableRateLimiting": true,\n        "Period": "2s",\n        "PeriodTimespan": 2,\n        "Limit": 1\n      },\n      // 超时熔断\n      "QoSOptions": {\n        "ExceptionsAllowedBeforeBreaking": 3,\n        "DurationOfBreak": 10000,\n        "TimeoutValue": 5000\n      }\n    },\n    {\n      "DownstreamPathTemplate": "/products",\n      "DownstreamScheme": "http",\n      "UpstreamPathTemplate": "/products",\n      "UpstreamHttpMethod": [ "Get" ],\n      "ServiceName": "product.service",\n      "LoadBalancerOptions": {\n        "Type": "RoundRobin"\n      },\n      // 缓存\n      "FileCacheOptions": {\n        "TtlSeconds": 5,\n        "Region": "regionname"\n      },\n      // 限流\n      "RateLimitOptions": {\n        "ClientWhitelist": [ "SuperClient" ],\n        "EnableRateLimiting": true,\n        "Period": "2s",\n        "PeriodTimespan": 2,\n        "Limit": 1\n      },\n      // 超时熔断\n      "QoSOptions": {\n        "ExceptionsAllowedBeforeBreaking": 3,\n        "DurationOfBreak": 10000,\n        "TimeoutValue": 5000\n      }\n    }\n  ],\n  "GlobalConfiguration": {\n    "BaseUrl": "http://localhost:5000",\n    "ServiceDiscoveryProvider": {\n      "Scheme": "http",\n      "Host": "192.168.31.191",\n      "Port": 8500,\n      "Type": "Consul"\n    },\n    "RateLimitOptions": {\n      "DisableRateLimitHeaders": false,\n      "QuotaExceededMessage": "too many requests...",\n      "HttpStatusCode": 999,\n      "ClientIdHeader": "Test"\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br")])]),n("p",[s._v("至此整个环境就有点复杂了。要确保 SqlServer，RabbitMQ，Consul，服务实例、Gateway都正常运行：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-02-13-24.png",alt:"img"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-02-00-46.png",alt:"img"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-02-01-06.png",alt:"img"}})]),s._v(" "),n("p",[n("code",[s._v("cap.published")]),s._v(" 表和 "),n("code",[s._v("cap.received")]),s._v(" 表由 "),n("code",[s._v("CAP")]),s._v(" 自动生成，内部使用本地消息表+MQ来实现异步确保。")]),s._v(" "),n("h1",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),n("p",[s._v("使用Postman作为客户端调用下单接口（5000是Ocelot网关端口）：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-02-19-58.png",alt:"img"}})]),s._v(" "),n("p",[s._v("订单库：\n"),n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-02-30-39.png",alt:"img"}})]),s._v(" "),n("p",[s._v("产品库：\n"),n("img",{attrs:{src:"https://wpl.wiki/images/2021-09-19-02-30-59.png",alt:"img"}})]),s._v(" "),n("p",[s._v("至此虽然功能很简单，但是实现了服务的解耦，异步调用，和最终一致性。要注意的是：")]),s._v(" "),n("ol",[n("li",[s._v("这里的事务是指：订单持久化到数据库/和下单事件保存到 "),n("code",[s._v("cap.published")]),s._v("表（保存到 "),n("code",[s._v("cap.published")]),s._v(" 表理论上代表消息正常发送到MQ），要么一同成功，要么一同失败。如果这个事务成功，那么就可以认为这个业务流程是成功的")]),s._v(" "),n("li",[s._v("产品服务的减库存是否成功那是产品服务的事，理论上也应该是成功的。因为消息已经确保发到了MQ，产品服务必然会收到消息。CAP也提供了失败重试，和失败回调机制，要理解 “CAP 是基于MQ加本地消息表来实现异步确保”")]),s._v(" "),n("li",[s._v("如果下单成功但是库存不足导致减库存失败了怎么办，是否需要回滚订单表的数据？如果产生这种想法，说明还没有真正理解最终一致性的思想。首先下单前肯定会检查一下库存数量，既然允许下单那么必然是库存充足的。（高并发下保证不超卖是另一个问题这里不考虑）如果非要数据回滚也是能实现的，CAP的 "),n("code",[s._v("ICapPublisher.Publish")]),s._v(" 方法提供一个"),n("code",[s._v("callbackName")]),s._v(" 参数，当减库存时，可以触发这个回调。其本质也是通过发布订阅完成，但不推荐")]),s._v(" "),n("li",[s._v("CAP无法保证消息不重复，实际使用中需要自己考虑一下实现消息的重复过滤和幂等")])])])}),[],!1,null,null,null);n.default=t.exports}}]);
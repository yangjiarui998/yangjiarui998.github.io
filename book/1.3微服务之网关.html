<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 杨家瑞的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="...">
    
    <link rel="preload" href="/assets/css/0.styles.9f84806b.css" as="style"><link rel="preload" href="/assets/js/app.c097a81f.js" as="script"><link rel="preload" href="/assets/js/2.5bf77379.js" as="script"><link rel="preload" href="/assets/js/1.5739cfb0.js" as="script"><link rel="preload" href="/assets/js/25.0c104f5e.js" as="script"><link rel="prefetch" href="/assets/js/10.8a7f92a8.js"><link rel="prefetch" href="/assets/js/11.117a6b7b.js"><link rel="prefetch" href="/assets/js/12.3a8e52cd.js"><link rel="prefetch" href="/assets/js/13.8696a8fa.js"><link rel="prefetch" href="/assets/js/14.6f479bb1.js"><link rel="prefetch" href="/assets/js/15.7abad6d0.js"><link rel="prefetch" href="/assets/js/16.3689a3a5.js"><link rel="prefetch" href="/assets/js/17.ef4d8cc7.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.c22d9498.js"><link rel="prefetch" href="/assets/js/21.388c94d1.js"><link rel="prefetch" href="/assets/js/22.227169e2.js"><link rel="prefetch" href="/assets/js/23.97186cf9.js"><link rel="prefetch" href="/assets/js/24.486bd800.js"><link rel="prefetch" href="/assets/js/26.bdab2bdd.js"><link rel="prefetch" href="/assets/js/27.5175be5e.js"><link rel="prefetch" href="/assets/js/28.709cca28.js"><link rel="prefetch" href="/assets/js/29.551bce44.js"><link rel="prefetch" href="/assets/js/3.c33b3aaa.js"><link rel="prefetch" href="/assets/js/30.ce7545d4.js"><link rel="prefetch" href="/assets/js/31.380e2917.js"><link rel="prefetch" href="/assets/js/32.af2fba44.js"><link rel="prefetch" href="/assets/js/33.4f5135e4.js"><link rel="prefetch" href="/assets/js/34.bdf93f6a.js"><link rel="prefetch" href="/assets/js/35.af3567a5.js"><link rel="prefetch" href="/assets/js/36.1580cd3f.js"><link rel="prefetch" href="/assets/js/37.a3670273.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/6.4910e764.js"><link rel="prefetch" href="/assets/js/7.c5640ac7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f84806b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="杨家瑞的博客" class="logo"> <span class="site-name can-hide">杨家瑞的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杨家瑞的博客" class="dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="杨家瑞的博客" class="mobile-dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/yangjiaruiaa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杨家瑞的博客" class="dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="杨家瑞的博客" class="mobile-dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/yangjiaruiaa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.NET</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liunx学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MicroService</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/1.1微服务项目搭建.html" class="sidebar-link">微服务项目搭建</a></li><li><a href="/book/1.2微服务之服务注册发现.html" class="sidebar-link">微服务项目之注册发现</a></li><li><a href="/book/1.3微服务之网关.html" class="active sidebar-link">微服务之网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/1.3微服务之网关.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/book/1.3微服务之网关.html#限流" class="sidebar-link">限流</a></li><li class="sidebar-sub-header"><a href="/book/1.3微服务之网关.html#超时-熔断" class="sidebar-link">超时/熔断</a></li></ul></li><li><a href="/book/1.4微服务之事件总线.html" class="sidebar-link">微服务之事件总线</a></li><li><a href="/book/Consul服务注册发现.html" class="sidebar-link">Consul服务注册发现</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>上一篇使用 Consul 完成了服务的注册与发现，实际中光有服务注册与发现往往是不够的，需要一个统一的入口来连接客户端与服务。</p> <h1 id="ocelot"><a href="#ocelot" class="header-anchor">#</a> Ocelot</h1> <p>官网：<a href="https://ocelot.readthedocs.io/" target="_blank" rel="noopener noreferrer">https://ocelot.readthedocs.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，Ocelot 正是为.Net微服务体系提供一个统一的入口点，称为：Gateway（网关）。</p> <p>首先创建一个空的 <code>asp.net core web</code> 项目：</p> <p><img src="https://wpl.wiki/images/2021-09-19-04-33-35.png" alt="img"></p> <blockquote><p>注意：<code>ocelot.json</code> 是Ocelot的配置文件，设置生成时需要复制到输出目录。<code>ocelot.json</code> 文件名不是固定的可以自己定义</p></blockquote> <p>使用 <code>NuGet</code> 安装 <code>Ocelot</code>，简单修改几处默认代码：</p> <p>Program.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class Program
{
    public static void Main(string[] args)
    {
        CreateHostBuilder(args).Build().Run();
    }

    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;
        Host.CreateDefaultBuilder(args)
            .ConfigureAppConfiguration((hostingContext, config) =&gt;
             {
                 config.AddJsonFile(&quot;ocelot.json&quot;, optional: false, reloadOnChange: true);
             })
            .ConfigureWebHostDefaults(webBuilder =&gt;
             {
                 webBuilder.UseStartup&lt;Startup&gt;();
             });
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Startup.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    // 添加ocelot服务
    services.AddOcelot();
}

// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // 启用Ocelot中间件
    app.UseOcelot().Wait();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>ocelot.json：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Routes&quot;: [
    {
      &quot;DownstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;DownstreamHostAndPorts&quot;: [
        {
          &quot;Host&quot;: &quot;192.168.31.191&quot;,
          &quot;Port&quot;: 80
        },
        {
          &quot;Host&quot;: &quot;192.168.31.191&quot;,
          &quot;Port&quot;: 81
        },
        {
          &quot;Host&quot;: &quot;192.168.31.191&quot;,
          &quot;Port&quot;: 82
        }
      ],
      &quot;UpstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;UpstreamHttpMethod&quot;: [
        &quot;Get&quot;
      ],
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot; //负载均衡，轮询机制 LeastConnection/RoundRobin/NoLoadBalancer/CookieStickySessions
      }
    }
  ],
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>这里将服务实例的地址写在配置文件中。</p> <p><code>Routes</code> 节点用来配置路由：</p> <ul><li><code>Downstream</code> 代表下游，也就是服务实例</li> <li><code>Upstream</code> 代表上游，也就是客户端。这里路径比较简单，只有 <code>/orders</code> 路径中如果有不固定参数则使用 <code>{}</code> 匹配。</li></ul> <p>这里配置的意思是：客户端访问网关的 <code>/orders</code>，网关会转发给服务实例的 <code>/orders</code> 。注意：上游的路径不一定要和下游一致，比如上游路径可以配置成 <code>/api/orders</code>。</p> <p><code>LoadBalancerOptions</code> 节点用来配置负载均衡，Ocelot 内置了 <code>LeastConnection</code> 、<code>RoundRobin</code> 、<code>NoLoadBalancer</code> 、<code>CookieStickySessions</code> 4种负载均衡策略：</p> <ul><li><code>LeastConnection</code> 最少连接，跟踪哪些服务正在处理请求，并把新请求发送到现有请求最少的服务上。该算法状态不在整个Ocelot集群中分布</li> <li><code>RoundRobin</code> 轮询可用的服务并发送请求。 该算法状态不在整个Ocelot集群中分布</li> <li><code>NoLoadBalancer</code> 不负载均衡，从配置或服务发现提供程序中取第一个可用的下游服务</li> <li><code>CookieStickySessions</code> 使用cookie关联所有相关的请求到制定的服务</li></ul> <p><code>BaseUrl</code> 节点用来配置 Ocelot 网关将要运行的地址。</p> <p>浏览器访问：</p> <p><img src="https://wpl.wiki/images/2021-09-17-21-18-20.png" alt="img"></p> <h1 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h1> <p>上面实现通过 Ocelot 网关访问服务实例，调整客户端代码：这里选择直接新建 <code>GatewayServiceHelper</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>using RestSharp;

using System;
using System.Threading.Tasks;

namespace Web.Client
{
    /// &lt;summary&gt;
    /// 通过OcelotGateway调用服务
    /// &lt;/summary&gt;
    public class GatewayServiceHelper : IServiceHelper
    {
        public async Task&lt;string&gt; GetOrder()
        {
            var client = new RestClient(&quot;http://localhost:5000&quot;);
            var request = new RestRequest(&quot;/orders&quot;, Method.GET);

            var response = await client.ExecuteAsync(request);
            return response.Content;
        }

        public void GetServices()
        {
            throw new NotImplementedException();
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>Startup.cs：修改注入类型</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>services.AddSingleton&lt;IServiceHelper, GatewayServiceHelper&gt;();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面获取服务地址的代码也不需要了</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 程序启动时获取服务列表
serviceHelper.GetServices();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>经过以上调整现在客户端对服务的调用都通过网关进行中转，客户端不再关心服务实例的地址，只需要知道网关地址就可以。另外服务端也避免了服务地址直接暴露给客户端。这样做对客户端，服务都非常友好。但是又出现了一个新的问题：目前服务地址写在 <code>ocelot.json</code> 配置文件中，一旦服务变化，需要人为的修改配置文件，这又显得不太合理。这里比较常用的方案是：结合Consul来实现服务发现。</p> <h1 id="服务发现"><a href="#服务发现" class="header-anchor">#</a> 服务发现</h1> <p><code>NuGet</code> 安装<code>Ocelot.Provider.Consul</code>后，修改Startup.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    // 添加Ocelot服务并添加Consul支持
    services.AddOcelot().AddConsul();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>修改ocelot.json配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Routes&quot;: [
    {
      &quot;DownstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;UpstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;UpstreamHttpMethod&quot;: [ &quot;Get&quot; ],
      &quot;ServiceName&quot;: &quot;order.service&quot;,
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot;
      }
    }
  ],
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;,
    &quot;ServiceDiscoveryProvider&quot;: {
      &quot;Scheme&quot;: &quot;http&quot;,
      &quot;Host&quot;: &quot;192.168.31.191&quot;,
      &quot;Port&quot;: 8500,
      &quot;Type&quot;: &quot;Consul&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这个配置很好理解，就是把 <code>DownstreamHostAndPorts</code> 节点去掉然后增加了 <code>ServiceDiscoveryProvider</code> 服务发现相关配置。</p> <blockquote><p>注意，Ocelot 除了支持 Consul 服务发现以外，还有 Eureka 也可以，Eureka 也是一个类似的注册中心</p></blockquote> <p>浏览器测试：</p> <p><img src="https://wpl.wiki/images/2021-09-17-21-35-46.png" alt="img"></p> <p>至此就实现了服务注册与发现和api网关的基本功能。接下来就要提到：服务治理。</p> <h1 id="服务治理"><a href="#服务治理" class="header-anchor">#</a> 服务治理</h1> <p>服务治理没有非常明确的定义。它的作用简单来说，就是帮我们更好的管理服务，提升服务的可用性。缓存、限流、熔断、链路追踪等等都属于常用的服务治理手段。之前讲的负载均衡，服务发现也可以算是服务治理。</p> <h2 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h2> <p>在 Ocelot 中启用缓存，需要<code>NuGet</code> 安装<code>Ocelot.Cache.CacheManager</code>，修改<code>Startup.cs</code> 中的 <code>ConfigureServices()</code> 方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    services.AddOcelot()
            .AddConsul()
            .AddCacheManager(p =&gt;
            {
                p.WithDictionaryHandle();
            });
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>修改 <code>ocelot.json</code> 配置文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Routes&quot;: [
    {
      &quot;DownstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;UpstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;UpstreamHttpMethod&quot;: [ &quot;Get&quot; ],
      &quot;ServiceName&quot;: &quot;order.service&quot;,
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot;
      },
      // 缓存
      &quot;FileCacheOptions&quot;: {
        &quot;TtlSeconds&quot;: 5,
        &quot;Region&quot;: &quot;regionname&quot;
      }
    }
  ],
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;,
    &quot;ServiceDiscoveryProvider&quot;: {
      &quot;Scheme&quot;: &quot;http&quot;,
      &quot;Host&quot;: &quot;192.168.31.191&quot;,
      &quot;Port&quot;: 8500,
      &quot;Type&quot;: &quot;Consul&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>在 Routes 路由配置中增加 <code>FileCacheOptions</code>：</p> <ul><li><code>TtlSeconds</code> 缓存的过期时间</li> <li><code>Region</code> 缓冲区名称，目前用不到</li></ul> <p>代码修改完编译重启一下网关项目，然后打开浏览器测试会发现5秒之内的请求都是同样的缓存数据。Ocelot也支持自定义缓存。</p> <h2 id="限流"><a href="#限流" class="header-anchor">#</a> 限流</h2> <p>限流就是限制客户端一定时间内的请求次数。</p> <p>修改 <code>ocelot.json</code> 配置文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Routes&quot;: [
    {
      &quot;DownstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;UpstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;UpstreamHttpMethod&quot;: [ &quot;Get&quot; ],
      &quot;ServiceName&quot;: &quot;order.service&quot;,
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot;
      },
      // 缓存
      &quot;FileCacheOptions&quot;: {
        &quot;TtlSeconds&quot;: 5,
        &quot;Region&quot;: &quot;regionname&quot;
      },
      // 限流
      &quot;RateLimitOptions&quot;: {
        &quot;ClientWhitelist&quot;: [ &quot;SuperClient&quot; ],
        &quot;EnableRateLimiting&quot;: true,
        &quot;Period&quot;: &quot;2s&quot;,
        &quot;PeriodTimespan&quot;: 2,
        &quot;Limit&quot;: 1
      }
    }
  ],
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;,
    &quot;ServiceDiscoveryProvider&quot;: {
      &quot;Scheme&quot;: &quot;http&quot;,
      &quot;Host&quot;: &quot;192.168.31.191&quot;,
      &quot;Port&quot;: 8500,
      &quot;Type&quot;: &quot;Consul&quot;
    },
    &quot;RateLimitOptions&quot;: {
      &quot;DisableRateLimitHeaders&quot;: false,
      &quot;QuotaExceededMessage&quot;: &quot;too many requests...&quot;,
      &quot;HttpStatusCode&quot;: 999,
      &quot;ClientIdHeader&quot;: &quot;Test&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>在 Routes 路由配置中增加 <code>RateLimitOptions</code> ：</p> <ul><li><code>ClientWhitelist</code> 客户端白名单（白名单中的客户端不受限流影响）</li> <li><code>EnableRateLimiting</code> 是否限流</li> <li><code>Period</code> 限流的单位时间，例如1s、5m、1h、1d等</li> <li><code>PeriodTimespan</code> 客户端达到请求上限多少秒后可以重试</li> <li><code>Limit</code> 客户端在定义的时间内可以发出的最大请求数</li></ul> <p>在 GlobalConfiguration 配置中也增加 <code>RateLimitOptions</code>：</p> <ul><li><code>DisableRateLimitHeaders</code> 是否禁用 <code>X-Rate-Limit</code> 和 <code>Retry-After</code> 标头（请求达到上限时response header中的限制数和多少秒后能重试）</li> <li><code>QuotaExceededMessage</code> ：请求达到上限时返回给客户端的消息</li> <li><code>HttpStatusCode</code> ：请求达到上限时返回给客户端的 <code>HTTP状态码</code></li> <li><code>ClientIdHeader</code> 可以允许自定义用于标识客户端的标头。默认情况下为 <code>ClientId</code></li></ul> <p>代码修改完编译重启一下网关项目，然后打开浏览器测试会发现限制已经生效。</p> <h2 id="超时-熔断"><a href="#超时-熔断" class="header-anchor">#</a> 超时/熔断</h2> <ul><li>超时：网关请求服务时可容忍的最长响应时间</li> <li>熔断：当请求某个服务的异常次数达到一定量时，网关在一定时间内就不再对这个服务发起请求直接熔断</li></ul> <p>在 Ocelot 中启用超时/熔断，需要 <code>NuGet</code> 安装<code>Ocelot.Provider.Polly</code>，修改<code>Startup.cs</code> 中的 <code>ConfigureServices()</code> 方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    services.AddOcelot()
            .AddConsul()
            .AddCacheManager(p =&gt;
            {
                p.WithDictionaryHandle();
            }).AddPolly();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>修改 <code>ocelot.json</code> 配置文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Routes&quot;: [
    {
      &quot;DownstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;UpstreamPathTemplate&quot;: &quot;/orders&quot;,
      &quot;UpstreamHttpMethod&quot;: [ &quot;Get&quot; ],
      &quot;ServiceName&quot;: &quot;order.service&quot;,
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot;
      },
      // 缓存
      &quot;FileCacheOptions&quot;: {
        &quot;TtlSeconds&quot;: 5,
        &quot;Region&quot;: &quot;regionname&quot;
      },
      // 限流
      &quot;RateLimitOptions&quot;: {
        &quot;ClientWhitelist&quot;: [ &quot;SuperClient&quot; ],
        &quot;EnableRateLimiting&quot;: true,
        &quot;Period&quot;: &quot;2s&quot;,
        &quot;PeriodTimespan&quot;: 2,
        &quot;Limit&quot;: 1
      },
      // 超时熔断
      &quot;QoSOptions&quot;: {
        &quot;ExceptionsAllowedBeforeBreaking&quot;: 3,
        &quot;DurationOfBreak&quot;: 10000,
        &quot;TimeoutValue&quot;: 5000
      }
    }
  ],
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;,
    &quot;ServiceDiscoveryProvider&quot;: {
      &quot;Scheme&quot;: &quot;http&quot;,
      &quot;Host&quot;: &quot;192.168.201.191&quot;,
      &quot;Port&quot;: 8500,
      &quot;Type&quot;: &quot;Consul&quot;
    },
    &quot;RateLimitOptions&quot;: {
      &quot;DisableRateLimitHeaders&quot;: false,
      &quot;QuotaExceededMessage&quot;: &quot;too many requests...&quot;,
      &quot;HttpStatusCode&quot;: 999,
      &quot;ClientIdHeader&quot;: &quot;Test&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><ul><li><code>ExceptionsAllowedBeforeBreaking</code> 发生错误的次数</li> <li><code>DurationOfBreak</code> 熔断时间</li> <li><code>TimeoutValue</code> 超时时间</li></ul> <p>以上配置意思是当请求服务发生3次错误时，就熔断10秒，期间客户端的请求直接返回错误，10秒后恢复。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/1.2微服务之服务注册发现.html" class="prev">
        微服务项目之注册发现
      </a></span> <span class="next"><a href="/book/1.4微服务之事件总线.html">
        微服务之事件总线
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c097a81f.js" defer></script><script src="/assets/js/2.5bf77379.js" defer></script><script src="/assets/js/1.5739cfb0.js" defer></script><script src="/assets/js/25.0c104f5e.js" defer></script>
  </body>
</html>

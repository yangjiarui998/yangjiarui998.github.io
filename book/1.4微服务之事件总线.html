<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 杨家瑞的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="...">
    
    <link rel="preload" href="/assets/css/0.styles.9f84806b.css" as="style"><link rel="preload" href="/assets/js/app.c097a81f.js" as="script"><link rel="preload" href="/assets/js/2.5bf77379.js" as="script"><link rel="preload" href="/assets/js/1.5739cfb0.js" as="script"><link rel="preload" href="/assets/js/26.bdab2bdd.js" as="script"><link rel="prefetch" href="/assets/js/10.8a7f92a8.js"><link rel="prefetch" href="/assets/js/11.117a6b7b.js"><link rel="prefetch" href="/assets/js/12.3a8e52cd.js"><link rel="prefetch" href="/assets/js/13.8696a8fa.js"><link rel="prefetch" href="/assets/js/14.6f479bb1.js"><link rel="prefetch" href="/assets/js/15.7abad6d0.js"><link rel="prefetch" href="/assets/js/16.3689a3a5.js"><link rel="prefetch" href="/assets/js/17.ef4d8cc7.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.c22d9498.js"><link rel="prefetch" href="/assets/js/21.388c94d1.js"><link rel="prefetch" href="/assets/js/22.227169e2.js"><link rel="prefetch" href="/assets/js/23.97186cf9.js"><link rel="prefetch" href="/assets/js/24.486bd800.js"><link rel="prefetch" href="/assets/js/25.0c104f5e.js"><link rel="prefetch" href="/assets/js/27.5175be5e.js"><link rel="prefetch" href="/assets/js/28.709cca28.js"><link rel="prefetch" href="/assets/js/29.551bce44.js"><link rel="prefetch" href="/assets/js/3.c33b3aaa.js"><link rel="prefetch" href="/assets/js/30.ce7545d4.js"><link rel="prefetch" href="/assets/js/31.380e2917.js"><link rel="prefetch" href="/assets/js/32.af2fba44.js"><link rel="prefetch" href="/assets/js/33.4f5135e4.js"><link rel="prefetch" href="/assets/js/34.bdf93f6a.js"><link rel="prefetch" href="/assets/js/35.af3567a5.js"><link rel="prefetch" href="/assets/js/36.1580cd3f.js"><link rel="prefetch" href="/assets/js/37.a3670273.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/6.4910e764.js"><link rel="prefetch" href="/assets/js/7.c5640ac7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f84806b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="杨家瑞的博客" class="logo"> <span class="site-name can-hide">杨家瑞的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杨家瑞的博客" class="dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="杨家瑞的博客" class="mobile-dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/yangjiaruiaa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杨家瑞的博客" class="dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="杨家瑞的博客" class="mobile-dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/yangjiaruiaa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.NET</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liunx学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MicroService</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/1.1微服务项目搭建.html" class="sidebar-link">微服务项目搭建</a></li><li><a href="/book/1.2微服务之服务注册发现.html" class="sidebar-link">微服务项目之注册发现</a></li><li><a href="/book/1.3微服务之网关.html" class="sidebar-link">微服务之网关</a></li><li><a href="/book/1.4微服务之事件总线.html" class="active sidebar-link">微服务之事件总线</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#productscontroller-cs" class="sidebar-link">ProductsController.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#createordermessagedto-cs" class="sidebar-link">CreateOrderMessageDto.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#product-cs" class="sidebar-link">Product.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#productcontext-cs" class="sidebar-link">ProductContext.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#appsettings-json" class="sidebar-link">appsettings.json</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#startup-cs" class="sidebar-link">Startup.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#orderscontroller-cs" class="sidebar-link">OrdersController.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#createordermessagedto-cs-2" class="sidebar-link">CreateOrderMessageDto.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#order-cs" class="sidebar-link">Order.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#ordercontext-cs" class="sidebar-link">OrderContext.cs</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#appsettings-json-2" class="sidebar-link">appsettings.json</a></li><li class="sidebar-sub-header"><a href="/book/1.4微服务之事件总线.html#startup-cs-2" class="sidebar-link">Startup.cs</a></li></ul></li><li><a href="/book/Consul服务注册发现.html" class="sidebar-link">Consul服务注册发现</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>上一篇中已经完成了 Ocelot + Consul 的搭建，这篇简单说一下事件总线（<code>EventBus</code>)。</p> <h1 id="事件总线"><a href="#事件总线" class="header-anchor">#</a> 事件总线</h1> <p>什么是事件总线？</p> <blockquote><p>事件总线是对观察者（发布-订阅）模式的一种实现。它是一种集中式事件处理机制，允许不同的组件之间进行彼此通信而又不需要相互依赖，达到解耦的目的</p></blockquote> <p>为什么要使用事件总线？</p> <blockquote><ol><li>以当前项目举例，假设有一个订单服务，一个产品服务。客户端有一个下单功能，下单时调用订单服务的下单接口，下单接口需要调用产品服务的减库存接口，这涉及到服务与服务之间的调用。服务之间调用可以选择 <code>RestAPI</code> 或者效率更高的 <code>gRPC</code>。可能这两者各有各的使用场景，但是它们都存在服务之间的耦合问题，或者难以做到异步调用</li> <li>假设下单调用订单服务，订单服务需要调用产品服务，产品服务又要调用物流服务，物流服务再去调用xx服务等等，如果每个服务处理时间需要2s，不使用异步处理的话，响应时间可想而知。如果使用EventBus的话，那么订单服务只需要向EventBus发一个“下单事件”就可以了。产品服务会订阅“下单事件”，当产品服务收到下单事件时，自己去减库存。这样就避免了两个服务之间直接调用的耦合性，并且真正做到了异步调用</li></ol></blockquote> <p>既然涉及到多个服务之间的异步调用，那么就不得不提分布式事务。分布式事务并不是微服务独有的问题，而是所有的分布式系统都会存在的问题。关于分布式事务，可以查一下 “CAP原则” 和 “BASE理论” 了解更多。如今分布式系统更多时候会追求事务的最终一致性。</p> <p>下面使用开源框架 <code>CAP</code>来演示 <code>EventBus</code> 的基本使用。之所以使用 <code>CAP</code> 是因为它既能解决分布式系统的最终一致性，同时又是一个 <code>EventBus</code>，它具备<code>EventBus</code> 的所有功能。<a href="https://www.cnblogs.com/savorboard/p/cap.html" target="_blank" rel="noopener noreferrer">点击了解更多<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h1 id="cap"><a href="#cap" class="header-anchor">#</a> CAP</h1> <p>目前 CAP 支持使用 <code>RabbitMQ</code> ，<code>Kafka</code>，<code>Azure Service Bus</code> 等进行底层之间的消息发送，不需要具备这些消息队列的使用经验就可以轻松的集成到项目中。CAP 目前支持使用 <code>Sql Server</code>，<code>MySql</code>，<code>PostgreSql</code>，<code>MongoDB</code> 数据库的项目。这里选择：消息组件使用 <code>RabbitMq</code>，数据库存储使用 <code>SqlServer</code>。</p> <p><code>Nuget</code> 安装 :</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Microsoft.EntityFrameworkCore
Microsoft.EntityFrameworkCore.Tools
Microsoft.EntityFrameworkCore.SqlServer
DotNetCore.CAP
DotNetCore.CAP.RabbitMQ
DotNetCore.CAP.SqlServer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h1 id="product-api"><a href="#product-api" class="header-anchor">#</a> Product.Api</h1> <p>新增 <code>Product.Api</code> 作为产品服务，代码结构与 <code>Order.Api</code> 结构类似：</p> <p><img src="https://wpl.wiki/images/2021-09-19-01-07-00.png" alt="img"></p> <h2 id="productscontroller-cs"><a href="#productscontroller-cs" class="header-anchor">#</a> ProductsController.cs</h2> <p>增加减库存接口：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>using DotNetCore.CAP;

using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;

using Newtonsoft.Json;

using Product.Api.Models;

using System;
using System.Threading.Tasks;

namespace Product.Api.Controller
{
    [Route(&quot;[Controller]&quot;)]
    [ApiController]
    public class ProductsController : ControllerBase
    {
        private readonly IConfiguration configuration;
        private readonly ICapPublisher capBus;
        private readonly ProductContext context;

        public ProductsController(IConfiguration configuration, ICapPublisher capBus, ProductContext context)
        {
            this.configuration = configuration;
            this.capBus = capBus;
            this.context = context;
        }

        [HttpGet]
        public IActionResult Index()
        {
            string result = $&quot;产品服务：{DateTime.Now:yyyy-MM-dd HH:mm:ss},-{Request.HttpContext.Connection.LocalIpAddress}:{configuration[&quot;ConsulSetting:ServicePort&quot;]}&quot;;
            return Ok(result);
        }

        /// &lt;summary&gt;
        /// 减库存 订阅下单事件
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;message&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [NonAction]
        [CapSubscribe(&quot;order.services.createorder&quot;)]
        public async Task ReduceStock(CreateOrderMessageDto message)
        {
            Console.WriteLine(&quot;message:&quot; + JsonConvert.SerializeObject(message));
            var product = await context.Products.FirstOrDefaultAsync(p =&gt; p.ID == message.ProductID);
            product.Stock -= message.Count;
            await context.SaveChangesAsync();
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h2 id="createordermessagedto-cs"><a href="#createordermessagedto-cs" class="header-anchor">#</a> CreateOrderMessageDto.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>namespace Product.Api.Models
{
    /// &lt;summary&gt;
    /// 下单事件消息
    /// &lt;/summary&gt;
    public class CreateOrderMessageDto
    {
        /// &lt;summary&gt;
        /// 产品ID
        /// &lt;/summary&gt;
        public int ProductID { get; set; }

        /// &lt;summary&gt;
        /// 购买数量
        /// &lt;/summary&gt;
        public int Count { get; set; }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="product-cs"><a href="#product-cs" class="header-anchor">#</a> Product.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Product.Api.Models
{
    public class Product
    {
        [Key]
        public int ID { get; set; }

        /// &lt;summary&gt;
        /// 产品名称
        /// &lt;/summary&gt;
        [Required]
        [Column(TypeName = &quot;VARCHAR(16)&quot;)]
        public string Name { get; set; }

        /// &lt;summary&gt;
        /// 库存
        /// &lt;/summary&gt;
        [Required]
        public int Stock { get; set; }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="productcontext-cs"><a href="#productcontext-cs" class="header-anchor">#</a> ProductContext.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>using Microsoft.EntityFrameworkCore;

namespace Product.Api
{
    public class ProductContext : DbContext
    {
        public ProductContext(DbContextOptions&lt;ProductContext&gt; options)
           : base(options)
        {

        }

        public DbSet&lt;Models.Product&gt; Products { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            //初始化种子数据
            modelBuilder.Entity&lt;Models.Product&gt;().HasData(new Models.Product
            {
                ID = 1,
                Name = &quot;ThinkPad&quot;,
                Stock = 100
            },
            new Models.Product
            {
                ID = 2,
                Name = &quot;Mac&quot;,
                Stock = 100
            });
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="appsettings-json"><a href="#appsettings-json" class="header-anchor">#</a> appsettings.json</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft&quot;: &quot;Warning&quot;,
      &quot;Microsoft.Hosting.Lifetime&quot;: &quot;Information&quot;
    }
  },
  &quot;AllowedHosts&quot;: &quot;*&quot;,
  &quot;ConsulSetting&quot;: {
    &quot;ServiceName&quot;: &quot;product.service&quot;,
    &quot;ServiceIP&quot;: &quot;192.168.31.191&quot;,
    &quot;ServiceHealthCheck&quot;: &quot;/healthcheck&quot;,
    &quot;ConsulAddress&quot;: &quot;http://192.168.31.191:8500&quot;
  },
  &quot;ConnectionString&quot;: &quot;Server=192.168.31.210;Database=Microservice.Sample.Product;user id=sa;password=wpl19950815;MultipleActiveResultSets=true&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="startup-cs"><a href="#startup-cs" class="header-anchor">#</a> Startup.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();

    services.AddDbContext&lt;ProductContext&gt;(opt =&gt; opt.UseSqlServer(Configuration[&quot;ConnectionString&quot;]));

    services.AddCap(x =&gt;
    {
        x.UseEntityFramework&lt;ProductContext&gt;().UseRabbitMQ(option =&gt;
        {
            option.HostName = &quot;192.168.31.191&quot;;
            option.UserName = &quot;guest&quot;;
            option.Password = &quot;guest&quot;;
        });
    });
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h1 id="order-api"><a href="#order-api" class="header-anchor">#</a> Order.Api</h1> <h2 id="orderscontroller-cs"><a href="#orderscontroller-cs" class="header-anchor">#</a> OrdersController.cs</h2> <p>增加下单接口：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>using DotNetCore.CAP;

using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;

using Order.Api.Models;

using System;
using System.Threading.Tasks;

namespace Order.Api.Controller
{
    [Route(&quot;[Controller]&quot;)]
    [ApiController]
    public class OrdersController : ControllerBase
    {
        private readonly IConfiguration configuration;
        private readonly ICapPublisher capBus;
        private readonly OrderContext context;

        public OrdersController(IConfiguration configuration, ICapPublisher capBus, OrderContext context)
        {
            this.configuration = configuration;
            this.capBus = capBus;
            this.context = context;
        }

        [HttpGet]
        public IActionResult Index()
        {
            string result = $&quot;订单服务：{DateTime.Now:yyyy-MM-dd HH:mm:ss},-{Request.HttpContext.Connection.LocalIpAddress}:{configuration[&quot;ConsulSetting:ServicePort&quot;]}&quot;;
            return Ok(result);
        }

        /// &lt;summary&gt;
        /// 创建订单
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;order&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Route(&quot;Create&quot;)]
        [HttpPost]
        public async Task&lt;IActionResult&gt; CreateOrder(Models.Order order)
        {
            using (var trans = context.Database.BeginTransaction(capBus, autoCommit: true))
            {
                order.CreateTime = DateTime.Now;
                context.Orders.Add(order);

                var result = await context.SaveChangesAsync() &gt; 0;

                if (result)
                {
                    // 发布下单事件
                    await capBus.PublishAsync(&quot;order.services.createorder&quot;,
                        new CreateOrderMessageDto() { Count = order.Count, ProductID = order.ProductID });
                    return Ok();
                }
                return BadRequest();
            }
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h2 id="createordermessagedto-cs-2"><a href="#createordermessagedto-cs-2" class="header-anchor">#</a> CreateOrderMessageDto.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>namespace Order.Api.Models
{
    /// &lt;summary&gt;
    /// 下单事件消息
    /// &lt;/summary&gt;
    public class CreateOrderMessageDto
    {
        /// &lt;summary&gt;
        /// 产品ID
        /// &lt;/summary&gt;
        public int ProductID { get; set; }

        /// &lt;summary&gt;
        /// 购买数量
        /// &lt;/summary&gt;
        public int Count { get; set; }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="order-cs"><a href="#order-cs" class="header-anchor">#</a> Order.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>using System;
using System.ComponentModel.DataAnnotations;

namespace Order.Api.Models
{
    public class Order
    {
        [Key]
        public int ID { get; set; }

        /// &lt;summary&gt;
        /// 下单时间
        /// &lt;/summary&gt;
        [Required]
        public DateTime CreateTime { get; set; }

        /// &lt;summary&gt;
        /// 产品ID
        /// &lt;/summary&gt;
        [Required]
        public int ProductID { get; set; }

        /// &lt;summary&gt;
        /// 购买数量
        /// &lt;/summary&gt;
        [Required]
        public int Count { get; set; }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="ordercontext-cs"><a href="#ordercontext-cs" class="header-anchor">#</a> OrderContext.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>using Microsoft.EntityFrameworkCore;

namespace Order.Api
{
    public class OrderContext : DbContext
    {
        public OrderContext(DbContextOptions&lt;OrderContext&gt; options)
           : base(options)
        {

        }

        public DbSet&lt;Models.Order&gt; Orders { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {

        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="appsettings-json-2"><a href="#appsettings-json-2" class="header-anchor">#</a> appsettings.json</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft&quot;: &quot;Warning&quot;,
      &quot;Microsoft.Hosting.Lifetime&quot;: &quot;Information&quot;
    }
  },
  &quot;AllowedHosts&quot;: &quot;*&quot;,
  &quot;ConsulSetting&quot;: {
    &quot;ServiceName&quot;: &quot;order.service&quot;,
    &quot;ServiceIP&quot;: &quot;192.168.31.191&quot;,
    &quot;ServiceHealthCheck&quot;: &quot;/healthcheck&quot;,
    &quot;ConsulAddress&quot;: &quot;http://192.168.31.191:8500&quot;
  },
  &quot;ConnectionString&quot;: &quot;Server=192.168.31.210;Database=Microservice.Sample.Order;user id=sa;password=wpl19950815;MultipleActiveResultSets=true&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="startup-cs-2"><a href="#startup-cs-2" class="header-anchor">#</a> Startup.cs</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();

    services.AddDbContext&lt;OrderContext&gt;(opt =&gt; opt.UseSqlServer(Configuration[&quot;ConnectionString&quot;]));

    services.AddCap(x =&gt;
    {
        x.UseEntityFramework&lt;OrderContext&gt;().UseRabbitMQ(option =&gt;
        {
            option.HostName = &quot;192.168.31.191&quot;;
            option.UserName = &quot;guest&quot;;
            option.Password = &quot;guest&quot;;
        });
    });
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="https://wpl.wiki/images/2021-09-19-01-20-20.png" alt="img"></p> <p>以上就是产品服务的新增以及订单服务的部分代码调整，功能很简单：各自添加自己的数据库表，订单服务增加下单接口，下单接口会发出“下单事件”。产品服务增加减库存接口，减库存接口会订阅“下单事件”。然后客户端调用下单接口下单时，产品服务会减去相应的库存。关于EF数据库迁移之类的基本使用不做介绍。</p> <h1 id="重新构建镜像"><a href="#重新构建镜像" class="header-anchor">#</a> 重新构建镜像</h1> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@centos-01 dotnetcore_src]# cd order.api.release/
[root@centos-01 order.api.release]# docker build -t order.api .
Sending build context to Docker daemon  16.05MB
Step 1/4 : FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base
 ---&gt; a2be3e478ffa
Step 2/4 : WORKDIR /app
 ---&gt; Using cache
 ---&gt; 9f551bd1698a
Step 3/4 : COPY . /app
 ---&gt; e19ab440e8a5
Step 4/4 : ENTRYPOINT [&quot;dotnet&quot;, &quot;Order.Api.dll&quot;]
 ---&gt; Running in 3d1e4110f02e
Removing intermediate container 3d1e4110f02e
 ---&gt; 06322a6c6e83
Successfully built 06322a6c6e83
Successfully tagged order.api:latest

[root@centos-01 order.api.release]# cd ../product.api.release/
[root@centos-01 product.api.release]# docker build -t product.api .
Sending build context to Docker daemon  16.38MB
Step 1/4 : FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS base
 ---&gt; a2be3e478ffa
Step 2/4 : WORKDIR /app
 ---&gt; Using cache
 ---&gt; 9f551bd1698a
Step 3/4 : COPY . /app
 ---&gt; 6f6d08e02d78
Step 4/4 : ENTRYPOINT [&quot;dotnet&quot;, &quot;Product.Api.dll&quot;]
 ---&gt; Running in 7616a505741e
Removing intermediate container 7616a505741e
 ---&gt; 6be08521c6fe
Successfully built 6be08521c6fe
Successfully tagged product.api:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>运行订单服务，产品服务：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -d --name order.api -p 80:80 order.api  --ConsulSetting:ServicePort=&quot;80&quot;
docker run -d --name order.api1 -p 81:80 order.api --ConsulSetting:ServicePort=&quot;81&quot;
docker run -d --name order.api2 -p 82:80 order.api --ConsulSetting:ServicePort=&quot;82&quot;
docker run -d --name product.api -p 85:80 product.api --ConsulSetting:ServicePort=&quot;85&quot;
docker run -d --name product.api1 -p 86:80 product.api --ConsulSetting:ServicePort=&quot;86&quot;
docker run -d --name product.api2 -p 87:80 product.api --ConsulSetting:ServicePort=&quot;87&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="https://wpl.wiki/images/2021-09-19-01-51-19.png" alt="img"></p> <p><code>ocelot.json</code> 增加路由配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Routes&quot;: [
    {
      // 路由规则匹配
      &quot;DownstreamPathTemplate&quot;: &quot;/orders/{url}&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;UpstreamPathTemplate&quot;: &quot;/orders/{url}&quot;,
      // 增加Post请求
      &quot;UpstreamHttpMethod&quot;: [ &quot;Get&quot;, &quot;Post&quot; ],
      &quot;ServiceName&quot;: &quot;order.service&quot;,
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot;
      },
      // 缓存
      &quot;FileCacheOptions&quot;: {
        &quot;TtlSeconds&quot;: 5,
        &quot;Region&quot;: &quot;regionname&quot;
      },
      // 限流
      &quot;RateLimitOptions&quot;: {
        &quot;ClientWhitelist&quot;: [ &quot;SuperClient&quot; ],
        &quot;EnableRateLimiting&quot;: true,
        &quot;Period&quot;: &quot;2s&quot;,
        &quot;PeriodTimespan&quot;: 2,
        &quot;Limit&quot;: 1
      },
      // 超时熔断
      &quot;QoSOptions&quot;: {
        &quot;ExceptionsAllowedBeforeBreaking&quot;: 3,
        &quot;DurationOfBreak&quot;: 10000,
        &quot;TimeoutValue&quot;: 5000
      }
    },
    {
      &quot;DownstreamPathTemplate&quot;: &quot;/products&quot;,
      &quot;DownstreamScheme&quot;: &quot;http&quot;,
      &quot;UpstreamPathTemplate&quot;: &quot;/products&quot;,
      &quot;UpstreamHttpMethod&quot;: [ &quot;Get&quot; ],
      &quot;ServiceName&quot;: &quot;product.service&quot;,
      &quot;LoadBalancerOptions&quot;: {
        &quot;Type&quot;: &quot;RoundRobin&quot;
      },
      // 缓存
      &quot;FileCacheOptions&quot;: {
        &quot;TtlSeconds&quot;: 5,
        &quot;Region&quot;: &quot;regionname&quot;
      },
      // 限流
      &quot;RateLimitOptions&quot;: {
        &quot;ClientWhitelist&quot;: [ &quot;SuperClient&quot; ],
        &quot;EnableRateLimiting&quot;: true,
        &quot;Period&quot;: &quot;2s&quot;,
        &quot;PeriodTimespan&quot;: 2,
        &quot;Limit&quot;: 1
      },
      // 超时熔断
      &quot;QoSOptions&quot;: {
        &quot;ExceptionsAllowedBeforeBreaking&quot;: 3,
        &quot;DurationOfBreak&quot;: 10000,
        &quot;TimeoutValue&quot;: 5000
      }
    }
  ],
  &quot;GlobalConfiguration&quot;: {
    &quot;BaseUrl&quot;: &quot;http://localhost:5000&quot;,
    &quot;ServiceDiscoveryProvider&quot;: {
      &quot;Scheme&quot;: &quot;http&quot;,
      &quot;Host&quot;: &quot;192.168.31.191&quot;,
      &quot;Port&quot;: 8500,
      &quot;Type&quot;: &quot;Consul&quot;
    },
    &quot;RateLimitOptions&quot;: {
      &quot;DisableRateLimitHeaders&quot;: false,
      &quot;QuotaExceededMessage&quot;: &quot;too many requests...&quot;,
      &quot;HttpStatusCode&quot;: 999,
      &quot;ClientIdHeader&quot;: &quot;Test&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>至此整个环境就有点复杂了。要确保 SqlServer，RabbitMQ，Consul，服务实例、Gateway都正常运行：</p> <p><img src="https://wpl.wiki/images/2021-09-19-02-13-24.png" alt="img"></p> <p><img src="https://wpl.wiki/images/2021-09-19-02-00-46.png" alt="img"></p> <p><img src="https://wpl.wiki/images/2021-09-19-02-01-06.png" alt="img"></p> <p><code>cap.published</code> 表和 <code>cap.received</code> 表由 <code>CAP</code> 自动生成，内部使用本地消息表+MQ来实现异步确保。</p> <h1 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h1> <p>使用Postman作为客户端调用下单接口（5000是Ocelot网关端口）：</p> <p><img src="https://wpl.wiki/images/2021-09-19-02-19-58.png" alt="img"></p> <p>订单库：
<img src="https://wpl.wiki/images/2021-09-19-02-30-39.png" alt="img"></p> <p>产品库：
<img src="https://wpl.wiki/images/2021-09-19-02-30-59.png" alt="img"></p> <p>至此虽然功能很简单，但是实现了服务的解耦，异步调用，和最终一致性。要注意的是：</p> <ol><li>这里的事务是指：订单持久化到数据库/和下单事件保存到 <code>cap.published</code>表（保存到 <code>cap.published</code> 表理论上代表消息正常发送到MQ），要么一同成功，要么一同失败。如果这个事务成功，那么就可以认为这个业务流程是成功的</li> <li>产品服务的减库存是否成功那是产品服务的事，理论上也应该是成功的。因为消息已经确保发到了MQ，产品服务必然会收到消息。CAP也提供了失败重试，和失败回调机制，要理解 “CAP 是基于MQ加本地消息表来实现异步确保”</li> <li>如果下单成功但是库存不足导致减库存失败了怎么办，是否需要回滚订单表的数据？如果产生这种想法，说明还没有真正理解最终一致性的思想。首先下单前肯定会检查一下库存数量，既然允许下单那么必然是库存充足的。（高并发下保证不超卖是另一个问题这里不考虑）如果非要数据回滚也是能实现的，CAP的 <code>ICapPublisher.Publish</code> 方法提供一个<code>callbackName</code> 参数，当减库存时，可以触发这个回调。其本质也是通过发布订阅完成，但不推荐</li> <li>CAP无法保证消息不重复，实际使用中需要自己考虑一下实现消息的重复过滤和幂等</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/1.3微服务之网关.html" class="prev">
        微服务之网关
      </a></span> <span class="next"><a href="/book/Consul服务注册发现.html">
        Consul服务注册发现
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c097a81f.js" defer></script><script src="/assets/js/2.5bf77379.js" defer></script><script src="/assets/js/1.5739cfb0.js" defer></script><script src="/assets/js/26.bdab2bdd.js" defer></script>
  </body>
</html>

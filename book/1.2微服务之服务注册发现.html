<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 杨家瑞的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="...">
    
    <link rel="preload" href="/assets/css/0.styles.db0d048b.css" as="style"><link rel="preload" href="/assets/js/app.a9af9233.js" as="script"><link rel="preload" href="/assets/js/2.59228454.js" as="script"><link rel="preload" href="/assets/js/1.5739cfb0.js" as="script"><link rel="preload" href="/assets/js/24.a64ef5c5.js" as="script"><link rel="prefetch" href="/assets/js/10.974ac213.js"><link rel="prefetch" href="/assets/js/11.f2c0161d.js"><link rel="prefetch" href="/assets/js/12.3a8e52cd.js"><link rel="prefetch" href="/assets/js/13.7a48dea7.js"><link rel="prefetch" href="/assets/js/14.6f479bb1.js"><link rel="prefetch" href="/assets/js/15.33db6b39.js"><link rel="prefetch" href="/assets/js/16.3689a3a5.js"><link rel="prefetch" href="/assets/js/17.ef4d8cc7.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.c22d9498.js"><link rel="prefetch" href="/assets/js/21.388c94d1.js"><link rel="prefetch" href="/assets/js/22.73185e29.js"><link rel="prefetch" href="/assets/js/23.2a96845d.js"><link rel="prefetch" href="/assets/js/25.46c07047.js"><link rel="prefetch" href="/assets/js/26.e75af6c4.js"><link rel="prefetch" href="/assets/js/27.4cf005dc.js"><link rel="prefetch" href="/assets/js/28.92e83a3d.js"><link rel="prefetch" href="/assets/js/29.3ab99c17.js"><link rel="prefetch" href="/assets/js/3.c33b3aaa.js"><link rel="prefetch" href="/assets/js/30.33a9a308.js"><link rel="prefetch" href="/assets/js/31.92edf1db.js"><link rel="prefetch" href="/assets/js/32.01443ace.js"><link rel="prefetch" href="/assets/js/33.acfb13da.js"><link rel="prefetch" href="/assets/js/34.1bac30e3.js"><link rel="prefetch" href="/assets/js/35.d6b749fa.js"><link rel="prefetch" href="/assets/js/4.6ea5ee78.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/6.e19f463c.js"><link rel="prefetch" href="/assets/js/7.c6ff705a.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.db0d048b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="杨家瑞的博客" class="logo"> <span class="site-name can-hide">杨家瑞的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杨家瑞的博客" class="dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="杨家瑞的博客" class="mobile-dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/yangjiaruiaa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杨家瑞的博客" class="dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="杨家瑞的博客" class="mobile-dropdown-title"><span class="title">杨家瑞的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/yangjiaruiaa" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.NET</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liunx学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MicroService</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/1.1微服务项目搭建.html" class="sidebar-link">微服务项目搭建</a></li><li><a href="/book/1.2微服务之服务注册发现.html" class="active sidebar-link">微服务项目之注册发现</a></li><li><a href="/book/1.3微服务之网关.html" class="sidebar-link">微服务之网关</a></li><li><a href="/book/1.4微服务之事件总线.html" class="sidebar-link">微服务之事件总线</a></li><li><a href="/book/Consul服务注册发现.html" class="sidebar-link">Consul服务注册发现</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>上一篇说到要做到服务的灵活伸缩需要有一种机制来实现，这个机制就是服务注册与发现。这并不是必须的，如果服务实例很少并且很稳定，就没有必要使用。</p> <h1 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h1> <ul><li>服务注册：简单理解就是有一个注册中心，每个服务实例启动时都去注册中心注册，告诉注册中心地址，端口等信息。同样删除时，也需要去注册中心删除，注册中心负责维护这些服务实例的信息</li> <li>服务发现：既然注册中心维护了各个服务实例的信息，那么客户端通过注册中心就很容易能发现服务的变化。有了服务注册与发现，客户端就不用再去配置各个服务实例的地址，改为从注册中心统一获取</li> <li>健康检查：注册中心要保证每个地址的可用状态，挂掉的实例不应该被客户端获取到，所以需要：健康检查。每个服务都需要提供一个用于健康检查的接口，这个接口不具备任何业务功能。服务注册时把这个接口的地址也告诉注册中心，注册中心会定时调用这个接口来检测服务是否正常，如果不正常，则将它移除，这样来保证了服务的可用性</li></ul> <p>常见注册中心有 <code>Consul</code>、<code>ZooKeeper</code>、<code>etcd</code>、<code>Eureka</code>。</p> <h1 id="consul"><a href="#consul" class="header-anchor">#</a> Consul</h1> <p>Consul官网：<a href="https://www.consul.io/" target="_blank" rel="noopener noreferrer">https://www.consul.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，主要功能有服务注册与发现、健康检查、K-V存储、多数据中心等，这里不做详细介绍。</p> <ul><li>安装：直接在官网下载解压即可</li> <li>运行：在 <code>consul.exe</code> 目录下打开命令行执行 <code>consul.exe agent -dev</code></li> <li>浏览器访问：<a href="http://localhost:8500/" target="_blank" rel="noopener noreferrer">http://localhost:8500<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>这里选择使用Docker来部署Consul：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker pull consul 
docker run -d -p 8500:8500 --restart=always --name=consul consul:latest agent -server -bootstrap -ui -node=1 -client='0.0.0.0'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><code>agent</code>： 表示启动 Agent 进程</li> <li><code>server</code>：表示启动 Consul Server 模式</li> <li><code>client</code>：表示启动 Consul Cilent 模式</li> <li><code>bootstrap</code>：表示这个节点是 Server-Leader ，每个数据中心只能运行一台服务器。技术角度上来看 Leader 是通过 Raft 算法选举的，但是集群第一次启动时需要一个引导 Leader，在引导群集后，建议不要使用此标志</li> <li><code>ui</code>：表示启动 Web UI 管理器，默认开放端口 <code>8500</code>，所以上面使用 Docker 命令把 <code>8500</code> 端口对外开放</li> <li><code>node</code>：节点的名称，集群中必须是唯一的，默认是该节点的主机名</li> <li><code>client</code>：Consul服务监听地址，这提供<code>HTTP</code>、<code>DNS</code>、<code>RPC</code>等服务，默认是 <code>127.0.0.1</code> 所以不对外提供服务，如果要对外提供服务改成 <code>0.0.0.0</code></li> <li><code>join</code>：表示加入到某一个集群中。 如：<code>-json=192.168.0.11</code></li></ul> <p><img src="https://wpl.wiki/images/2021-09-17-20-00-01.png" alt="img"></p> <p>这里看到Consul已经成功运行。</p> <h1 id="服务注册"><a href="#服务注册" class="header-anchor">#</a> 服务注册</h1> <p>订单服务项目使用<code>Nuget</code> 安装 <code>Consul</code>，然后添加相关代码：</p> <p>ConsulHelper.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public static class ConsulHelper
{
    /// &lt;summary&gt;
    /// 服务注册
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;app&quot;&gt;The application.&lt;/param&gt;
    /// &lt;param name=&quot;configuration&quot;&gt;The configuration.&lt;/param&gt;
    /// &lt;param name=&quot;lifetime&quot;&gt;The lifetime.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IApplicationBuilder RegisterConsul(this IApplicationBuilder app
        , IConfiguration configuration
        , IHostApplicationLifetime lifetime)
    {
        var consulClient = new ConsulClient(c =&gt;
        {
            c.Address = new Uri(configuration[&quot;ConsulSetting:ConsulAddress&quot;]);
        });

        var registration = new AgentServiceRegistration()
        {
            // 服务实例唯一标识
            ID = Guid.NewGuid().ToString(),
            // 服务名称
            Name = configuration[&quot;ConsulSetting:ServiceName&quot;],
            // 服务IP地址
            Address = configuration[&quot;ConsulSetting:ServiceIP&quot;],
            // 服务端口：因为要运行多个实例，端口不能在appsettings.json里配置而是在docker容器运行时传入
            Port = int.Parse(configuration[&quot;ConsulSetting:ServicePort&quot;]),
            Check = new AgentServiceCheck()
            {
                // 服务启动多久后注册
                DeregisterCriticalServiceAfter = TimeSpan.FromSeconds(3),
                // 健康检查时间间隔
                Interval = TimeSpan.FromSeconds(10),
                // 健康检查地址
                HTTP = $&quot;http://{configuration[&quot;ConsulSetting:ServiceIP&quot;]}:{configuration[&quot;ConsulSetting:ServicePort&quot;]}{configuration[&quot;ConsulSetting:ServiceHealthCheck&quot;]}&quot;,
                // 超时时间
                Timeout = TimeSpan.FromSeconds(5)
            }
        };

        // 服务注册
        consulClient.Agent.ServiceRegister(registration).Wait();

        // 应用程序终止时，取消注册
        lifetime.ApplicationStopping.Register(() =&gt;
        {
            consulClient.Agent.ServiceDeregister(registration.ID).Wait();
        });
        return app;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>appsettings.json：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft&quot;: &quot;Warning&quot;,
      &quot;Microsoft.Hosting.Lifetime&quot;: &quot;Information&quot;
    }
  },
  &quot;AllowedHosts&quot;: &quot;*&quot;,
  &quot;ConsulSetting&quot;: {
    &quot;ServiceName&quot;: &quot;order.service&quot;,
    &quot;ServiceIP&quot;: &quot;192.168.31.191&quot;,
    &quot;ServiceHealthCheck&quot;: &quot;/healthcheck&quot;,
    &quot;ConsulAddress&quot;: &quot;http://192.168.31.191:8500&quot;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>注意：这里没有配置ServicePort，所以如果本地直接运行项目会报错</p></blockquote> <p>Startup.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void Configure(IApplicationBuilder app, IWebHostEnvironment env, IHostApplicationLifetime lifetime)
{
    if (env.IsDevelopment())
    { }
    else
    { }

    app.UseStaticFiles();

    app.UseRouting();
    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapControllers();
    });

    // 启用服务注册
    app.RegisterConsul(Configuration, lifetime);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>OrdersController.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[Route(&quot;[Controller]&quot;)]
[ApiController]
public class OrdersController : ControllerBase
{
    private readonly IConfiguration configuration;

    public OrdersController(IConfiguration configuration)
    {
        this.configuration = configuration;
    }

    [HttpGet]
    public IActionResult Index()
    {
        string result = $&quot;订单服务：{DateTime.Now:yyyy-MM-dd HH:mm:ss},-{Request.HttpContext.Connection.LocalIpAddress}:{configuration[&quot;ConsulSetting:ServicePort&quot;]}&quot;;
        return Ok(result);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>HealthCheckController.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[Route(&quot;[controller]&quot;)]
[ApiController]
public class HealthCheckController : ControllerBase
{
    /// &lt;summary&gt;
    /// 健康检查接口
    /// &lt;/summary&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    [HttpGet]
    public IActionResult Get()
    {
        return Ok(&quot;Pong.&quot;);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>至此就完成了服务注册、取消注册、健康检查的代码编写，下面重新 <code>build</code> 镜像（过程略过）运行新的容器：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@centos-01 order.api.release]# docker run -d --name order.api -p 80:80 order.api  --ConsulSetting:ServicePort=&quot;80&quot;
89acc7d7035f2041a91bc1e1299464a5460290dd66b12161ee4e994d5548def2
[root@centos-01 order.api.release]# docker run -d --name order.api1 -p 81:80 order.api --ConsulSetting:ServicePort=&quot;81&quot;
223be73a41e501e168fdc44459cd6f5851d565e60817dbd0047dff7718394e22
[root@centos-01 order.api.release]# docker run -d --name order.api2 -p 82:80 order.api --ConsulSetting:ServicePort=&quot;82&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://wpl.wiki/images/2021-09-17-20-36-21.png" alt="img"> <img src="https://wpl.wiki/images/2021-09-17-20-36-40.png" alt="img"></p> <p>至此，3个服务实例都已运行，并且成功注册到 Consul。测试一下服务停止会不会从Consul移除：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@centos-01 order.api.release]# docker stop order.api
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://wpl.wiki/images/2021-09-17-20-39-00.png" alt="img"></p> <p>这里需要注意：程序发生异常，健康检查不能正确响应的话，Consul也会移除。至此注册、发现、健康检查功能都完成了，下一步考虑客户端如何拿到这些服务实例的地址。</p> <h1 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h1> <p>上面已经成功将服务注册到 Consul中，接下来就该客户端通过 Consul 去做服务发现了。客户端项目同样使用<code>Nuget</code> 安装 Consul，然后调整相关代码：</p> <p>ServiceHelper.cs：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>using Consul;

using Microsoft.Extensions.Configuration;

using RestSharp;

using System;
using System.Collections.Concurrent;
using System.Linq;
using System.Threading.Tasks;

namespace Web.Client
{
    public interface IServiceHelper
    {
        Task&lt;string&gt; GetOrder();
    }

    public class ServiceHelper : IServiceHelper
    {
        private readonly IConfiguration configuration;

        public ServiceHelper(IConfiguration configuration)
        {
            this.configuration = configuration;
        }

        public async Task&lt;string&gt; GetOrder()
        {
            var consulClient = new ConsulClient(c =&gt;
            {
                c.Address = new Uri(configuration[&quot;ConsulSetting:ConsulAddress&quot;]);
            });

            // 获取健康的服务
            var services = consulClient.Health.Service(&quot;order.service&quot;, null, true, null).Result.Response;
            // 获取订单服务地址列表
            string[] serviceUrls = services.Select(p =&gt; $&quot;http://{p.Service.Address + &quot;:&quot; + p.Service.Port}&quot;).ToArray();

            if (!serviceUrls.Any())
            {
                return await Task.FromResult(&quot;【订单服务】服务列表为空&quot;);
            }

            // 每次随机访问一个服务实例
            var client = new RestClient(serviceUrls[new Random().Next(0, serviceUrls.Length)]);
            var request = new RestRequest(&quot;/orders&quot;, Method.GET);

            var response = await client.ExecuteAsync(request);
            return response.Content;
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>appsettings.json：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;Logging&quot;: {
    &quot;LogLevel&quot;: {
      &quot;Default&quot;: &quot;Information&quot;,
      &quot;Microsoft&quot;: &quot;Warning&quot;,
      &quot;Microsoft.Hosting.Lifetime&quot;: &quot;Information&quot;
    }
  },
  &quot;AllowedHosts&quot;: &quot;*&quot;,
  &quot;ConsulSetting&quot;: {
    &quot;ConsulAddress&quot;: &quot;http://192.168.31.191:8500&quot;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>以上代码就完成了对服务列表的获取，浏览器访问测试一下：</p> <p><img src="https://wpl.wiki/images/2021-09-17-20-48-22.png" alt="img"></p> <p>这时候如果停止其中一个服务实例，Consul中也会同步下线，客户端也就访问不到了，但是只要三个实例活着一个就可以正常访问。虽然这里解决了服务发现的问题，但是新的问题又来了：客户端每次调用服务都需要先去Consul中获取服务地址，不仅浪费资源还增加了请求的响应时间。如何保证不要每次请求都需要去Consul 获取地址的同时又可以拿到可用的地址列表呢？Consul 提供的解决方案是：Blocking Queries （阻塞的请求）。详情见官网：<a href="https://www.consul.io/api-docs/features/blocking" target="_blank" rel="noopener noreferrer">Blocking Queries<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <h1 id="blocking-queries"><a href="#blocking-queries" class="header-anchor">#</a> Blocking Queries</h1> <p>简单来说就是当客户端请求 Consul 获取地址列表时，需要携带一个版本号信息，Consul 会比较这个客户端版本号是否和 Consul 服务端的版本号一致，如果一致，则 Consul 会阻塞这个请求，直到 Consul 中的服务列表发生变化，或者到达阻塞时间上限；如果版本号不一致，则立即返回。这个阻塞时间默认是5分钟，支持自定义。如果启动一个线程专门去做这件事，就不会影响每次的用户请求了。这样既保证了客户端服务列表的准确性，又节约了客户端请求服务列表的次数。</p> <p>调整代码：</p> <p>IServiceHelper.cs 增加获取服务列表的接口方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>using Consul;

using Microsoft.Extensions.Configuration;

using RestSharp;

using System;
using System.Collections.Concurrent;
using System.Linq;
using System.Threading.Tasks;

namespace Web.Client
{
    public interface IServiceHelper
    {
        Task&lt;string&gt; GetOrder();

        void GetServices();
    }

    public class ServiceHelper : IServiceHelper
    {
        private readonly IConfiguration configuration;
        private readonly ConsulClient consulClient;
        private ConcurrentBag&lt;string&gt; orderServiceUrls;

        public ServiceHelper(IConfiguration configuration)
        {
            this.configuration = configuration;
            this.consulClient = new ConsulClient(c =&gt;
            {
                c.Address = new Uri(configuration[&quot;ConsulSetting:ConsulAddress&quot;]);
            });
        }

        public async Task&lt;string&gt; GetOrder()
        {
            if (orderServiceUrls == null)
                return await Task.FromResult(&quot;【订单服务】初始化服务列表...&quot;);

            var client = new RestClient(orderServiceUrls.ElementAt(new Random().Next(0, orderServiceUrls.Count())));
            var request = new RestRequest(&quot;/orders&quot;, Method.GET);

            var response = await client.ExecuteAsync(request);
            return response.Content;
        }

        public void GetServices()
        {
            var serviceNames = new string[] { &quot;order.service&quot; };
            Array.ForEach(serviceNames, p =&gt;
            {
                Task.Run(() =&gt;
                {
                    // WaitTime默认为5分钟
                    var queryOptions = new QueryOptions { WaitTime = TimeSpan.FromMinutes(10) };
                    while (true)
                    {
                        GetServices(queryOptions, p);
                    }
                });
            });
        }
        private void GetServices(QueryOptions queryOptions, string serviceName)
        {
            var res = consulClient.Health.Service(serviceName, null, true, queryOptions).Result;

            // 打印服务列表的响应时间等信息
            Console.WriteLine($&quot;{DateTime.Now}获取{serviceName}：queryOptions.WaitIndex：{queryOptions.WaitIndex}  LastIndex：{res.LastIndex}&quot;);

            // 版本号不一致 说明服务列表发生变化
            if (queryOptions.WaitIndex != res.LastIndex)
            {
                queryOptions.WaitIndex = res.LastIndex;

                //服务地址列表
                var serviceUrls = res.Response.Select(p =&gt; $&quot;http://{p.Service.Address + &quot;:&quot; + p.Service.Port}&quot;).ToArray();

                if (serviceName == &quot;order.service&quot;)
                    orderServiceUrls = new ConcurrentBag&lt;string&gt;(serviceUrls);
            }
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><p><img src="https://wpl.wiki/images/2021-09-17-21-02-33.png" alt="img"></p> <p>至此不需要每次都先请求服务列表，如果服务列表没有更新的话，获取列表的请求会一直阻塞直到设置的10分钟。这时候又发现新的问题：</p> <ol><li>每个客户端系统都去维护服务地址是否合理</li> <li>服务的IP端口直接暴露给所有客户端是否安全</li> <li>该模式下怎么做到客户端的统一管理</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/1.1微服务项目搭建.html" class="prev">
        微服务项目搭建
      </a></span> <span class="next"><a href="/book/1.3微服务之网关.html">
        微服务之网关
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a9af9233.js" defer></script><script src="/assets/js/2.59228454.js" defer></script><script src="/assets/js/1.5739cfb0.js" defer></script><script src="/assets/js/24.a64ef5c5.js" defer></script>
  </body>
</html>
